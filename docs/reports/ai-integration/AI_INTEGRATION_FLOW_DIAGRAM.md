# AI Integration Flow Diagram - Detailed Visual

## Complete Data Flow: User Request â†’ Enhanced Narration

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           USER / CLIENT CODE                                â”‚
â”‚                                                                             â”‚
â”‚  from video_gen.shared.models import InputConfig                           â”‚
â”‚  from video_gen.pipeline import PipelineOrchestrator                       â”‚
â”‚                                                                             â”‚
â”‚  input_config = InputConfig(                                               â”‚
â”‚      input_type="document",                                                â”‚
â”‚      source="tutorial.md",                                                 â”‚
â”‚      use_ai_narration=True,  â—„â”€â”€ AI ENHANCEMENT FLAG                      â”‚
â”‚      voice="male",                                                         â”‚
â”‚      accent_color="blue"                                                   â”‚
â”‚  )                                                                          â”‚
â”‚                                                                             â”‚
â”‚  orchestrator = PipelineOrchestrator()                                     â”‚
â”‚  result = await orchestrator.execute(input_config)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PIPELINE ORCHESTRATOR                                  â”‚
â”‚                    (orchestrator.py:73-233)                                 â”‚
â”‚                                                                             â”‚
â”‚  Task ID: task_abc123def456                                                â”‚
â”‚                                                                             â”‚
â”‚  Context Dictionary Created:                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ {                                                            â”‚          â”‚
â”‚  â”‚   "task_id": "task_abc123def456",                           â”‚          â”‚
â”‚  â”‚   "input_config": <InputConfig object>,  â—„â”€â”€ OBJECT!       â”‚          â”‚
â”‚  â”‚   "config": <Config singleton>                              â”‚          â”‚
â”‚  â”‚ }                                                            â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                             â”‚
â”‚  Pipeline Stages (sequential execution):                                   â”‚
â”‚  1. âœ“ InputStage        â†’ Adds "video_config" to context                  â”‚
â”‚  2. âœ“ ParsingStage      â†’ Enriches scenes with parsed content             â”‚
â”‚  3. â†’ ScriptStage       â—„â”€â”€ WE ARE HERE                                   â”‚
â”‚  4. AudioStage                                                             â”‚
â”‚  5. VideoStage                                                             â”‚
â”‚  6. OutputStage                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   SCRIPT GENERATION STAGE                                   â”‚
â”‚                  (script_generation_stage.py)                               â”‚
â”‚                                                                             â”‚
â”‚  Line 40-42: Check AI Enhancement Flag                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ input_config = context.get("input_config")                   â”‚         â”‚
â”‚  â”‚ use_ai = (input_config.use_ai_narration if input_config      â”‚         â”‚
â”‚  â”‚           and hasattr(input_config, 'use_ai_narration')      â”‚         â”‚
â”‚  â”‚           else False)                                         â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                             â”‚
â”‚  âœ“ use_ai = True  (from input_config.use_ai_narration)                    â”‚
â”‚  âœ“ self.ai_enhancer exists (initialized if ANTHROPIC_API_KEY set)         â”‚
â”‚                                                                             â”‚
â”‚  Line 50-98: Process Each Scene                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ for i, scene in enumerate(video_config.scenes):              â”‚         â”‚
â”‚  â”‚                                                               â”‚         â”‚
â”‚  â”‚     # 1. Generate base narration                             â”‚         â”‚
â”‚  â”‚     narration = await narration_generator.generate(          â”‚         â”‚
â”‚  â”‚         scene,              â—„â”€â”€ Pass Scene object            â”‚         â”‚
â”‚  â”‚         scene_type=scene.scene_type,                         â”‚         â”‚
â”‚  â”‚         language="en"                                         â”‚         â”‚
â”‚  â”‚     )                                                         â”‚         â”‚
â”‚  â”‚     # Result: "Here are the key concepts for this topic"     â”‚         â”‚
â”‚  â”‚                                                               â”‚         â”‚
â”‚  â”‚     # 2. Build context for AI enhancement                    â”‚         â”‚
â”‚  â”‚     enhanced_context = {                                      â”‚         â”‚
â”‚  â”‚         'scene_position': i,           # 0, 1, 2, ...        â”‚         â”‚
â”‚  â”‚         'total_scenes': len(scenes),   # e.g., 10            â”‚         â”‚
â”‚  â”‚         **(scene.parsed_content if hasattr...)  â—„â”€â”€ BUG!     â”‚         â”‚
â”‚  â”‚     }                                                         â”‚         â”‚
â”‚  â”‚     # Result context: {'scene_position': 0, 'total_scenes': 10} â”‚      â”‚
â”‚  â”‚     # SHOULD BE: {..., 'title': 'Main Title', ...}           â”‚         â”‚
â”‚  â”‚                                                               â”‚         â”‚
â”‚  â”‚     # 3. Enhance with AI                                     â”‚         â”‚
â”‚  â”‚     if use_ai and self.ai_enhancer:                          â”‚         â”‚
â”‚  â”‚         narration = await ai_enhancer.enhance(               â”‚         â”‚
â”‚  â”‚             narration,                                        â”‚         â”‚
â”‚  â”‚             scene_type=scene.scene_type,                     â”‚         â”‚
â”‚  â”‚             context=enhanced_context                          â”‚         â”‚
â”‚  â”‚         )                                                     â”‚         â”‚
â”‚  â”‚                                                               â”‚         â”‚
â”‚  â”‚     # 4. Update scene with enhanced narration                â”‚         â”‚
â”‚  â”‚     scene.narration = narration                              â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                             â”‚
â”‚  Lines 102-115: Log AI Usage Metrics                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ if use_ai and self.ai_enhancer.metrics:                      â”‚         â”‚
â”‚  â”‚     summary = self.ai_enhancer.metrics.get_summary()         â”‚         â”‚
â”‚  â”‚     if isinstance(summary, dict):                            â”‚         â”‚
â”‚  â”‚         self.logger.info(                                     â”‚         â”‚
â”‚  â”‚             f"ğŸ’° AI Usage: {summary['api_calls']} calls, "   â”‚         â”‚
â”‚  â”‚             f"${summary['estimated_cost_usd']:.4f}, "        â”‚         â”‚
â”‚  â”‚             f"{summary['success_rate']:.1f}% success"        â”‚         â”‚
â”‚  â”‚         )                                                     â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AI SCRIPT ENHANCER                                   â”‚
â”‚                      (ai_enhancer.py:86-201)                                â”‚
â”‚                                                                             â”‚
â”‚  Input Parameters:                                                          â”‚
â”‚  â€¢ script: "Here are the key concepts for this topic"                      â”‚
â”‚  â€¢ scene_type: "list"                                                      â”‚
â”‚  â€¢ context: {'scene_position': 0, 'total_scenes': 10}                     â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ STEP 1: Extract Scene Position Info (lines 110-112)                â”‚  â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚
â”‚  â”‚ scene_position = context.get('scene_position', 0)  # 0             â”‚  â”‚
â”‚  â”‚ total_scenes = context.get('total_scenes', 1)      # 10            â”‚  â”‚
â”‚  â”‚ scene_number = scene_position + 1                  # 1 (1st scene) â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ STEP 2: Determine Narrative Position (lines 115-124)               â”‚  â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚
â”‚  â”‚ if scene_number == 1:                                              â”‚  â”‚
â”‚  â”‚     position_context = "This is the OPENING scene - set the tone"  â”‚  â”‚
â”‚  â”‚ elif scene_number == total_scenes:                                 â”‚  â”‚
â”‚  â”‚     position_context = "This is the FINAL scene - provide closure" â”‚  â”‚
â”‚  â”‚ elif scene_number == 2:                                            â”‚  â”‚
â”‚  â”‚     position_context = "This is the second scene - transition"     â”‚  â”‚
â”‚  â”‚ elif scene_number == total_scenes - 1:                             â”‚  â”‚
â”‚  â”‚     position_context = "This is second-to-last - prepare for end"  â”‚  â”‚
â”‚  â”‚ else:                                                               â”‚  â”‚
â”‚  â”‚     position_context = f"This is scene {n} of {total} - maintain   â”‚  â”‚
â”‚  â”‚                          narrative flow"                            â”‚  â”‚
â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚ Result: "This is the OPENING scene - set the tone and hook viewer" â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ STEP 3: Map Scene Type to Context (lines 127-137)                  â”‚  â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚
â”‚  â”‚ scene_context = {                                                   â”‚  â”‚
â”‚  â”‚     'title': 'opening/header slide',                               â”‚  â”‚
â”‚  â”‚     'list': 'bulleted list of topics/concepts',  â—„â”€â”€ MATCHED      â”‚  â”‚
â”‚  â”‚     'command': 'technical commands/code',                          â”‚  â”‚
â”‚  â”‚     'outro': 'closing/call-to-action',                             â”‚  â”‚
â”‚  â”‚     ...                                                             â”‚  â”‚
â”‚  â”‚ }.get(scene_type, 'general content')                               â”‚  â”‚
â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚ Result: "bulleted list of topics/concepts"                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ STEP 4: Build Enhancement Prompt (lines 139-163)                   â”‚  â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚
â”‚  â”‚ prompt = f"""                                                       â”‚  â”‚
â”‚  â”‚ You are a professional narrator for technical educational videos.  â”‚  â”‚
â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚ Original narration: "Here are the key concepts for this topic"     â”‚  â”‚
â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚ Scene Context: bulleted list of topics/concepts                    â”‚  â”‚
â”‚  â”‚ Position Context: This is the OPENING scene - set the tone...      â”‚  â”‚
â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚ Enhancement Guidelines:                                             â”‚  â”‚
â”‚  â”‚ - Make it sound natural when spoken aloud                          â”‚  â”‚
â”‚  â”‚ - Keep it concise and clear                                        â”‚  â”‚
â”‚  â”‚ - Maintain all technical accuracy                                  â”‚  â”‚
â”‚  â”‚ - Use conversational but professional tone                         â”‚  â”‚
â”‚  â”‚ - Keep similar length (Â±30%)                                       â”‚  â”‚
â”‚  â”‚ - Use appropriate opening hooks and enthusiasm                     â”‚  â”‚
â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚ Quality Requirements:                                               â”‚  â”‚
â”‚  â”‚ - Must be 20-200 words (strict limit)                              â”‚  â”‚
â”‚  â”‚ - No markdown formatting or special characters                     â”‚  â”‚
â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚ Return ONLY the enhanced narration text.                           â”‚  â”‚
â”‚  â”‚ """                                                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ STEP 5: Call Claude API (lines 165-172)                            â”‚  â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚
â”‚  â”‚ import anthropic                                                    â”‚  â”‚
â”‚  â”‚ client = anthropic.Anthropic(api_key=self.api_key)                â”‚  â”‚
â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚ response = client.messages.create(                                 â”‚  â”‚
â”‚  â”‚     model="claude-sonnet-4-5-20250929",  â—„â”€â”€ Sonnet 4.5           â”‚  â”‚
â”‚  â”‚     max_tokens=500,                                                 â”‚  â”‚
â”‚  â”‚     messages=[{                                                     â”‚  â”‚
â”‚  â”‚         "role": "user",                                             â”‚  â”‚
â”‚  â”‚         "content": prompt                                           â”‚  â”‚
â”‚  â”‚     }]                                                              â”‚  â”‚
â”‚  â”‚ )                                                                   â”‚  â”‚
â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚ enhanced = response.content[0].text.strip()                        â”‚  â”‚
â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚ Result: "Let's explore the essential concepts that form the        â”‚  â”‚
â”‚  â”‚          foundation of this topic. These key ideas will help you   â”‚  â”‚
â”‚  â”‚          understand how everything works together."                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ STEP 6: Track Usage Metrics (lines 177-182)                        â”‚  â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚
â”‚  â”‚ usage = response.usage                                              â”‚  â”‚
â”‚  â”‚ # usage.input_tokens = 450                                          â”‚  â”‚
â”‚  â”‚ # usage.output_tokens = 135                                         â”‚  â”‚
â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚ self.metrics.record_call(                                           â”‚  â”‚
â”‚  â”‚     input_tokens=450,                                               â”‚  â”‚
â”‚  â”‚     output_tokens=135,                                              â”‚  â”‚
â”‚  â”‚     success=True                                                    â”‚  â”‚
â”‚  â”‚ )                                                                   â”‚  â”‚
â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚ # Cost calculation:                                                 â”‚  â”‚
â”‚  â”‚ # (450/1M * $3) + (135/1M * $15) = $0.00135 + $0.002025 = $0.00338â”‚  â”‚
â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚ metrics.total_api_calls += 1           # Now: 1                    â”‚  â”‚
â”‚  â”‚ metrics.total_input_tokens += 450      # Now: 450                  â”‚  â”‚
â”‚  â”‚ metrics.total_output_tokens += 135     # Now: 135                  â”‚  â”‚
â”‚  â”‚ metrics.total_cost_usd += 0.00338      # Now: $0.0034             â”‚  â”‚
â”‚  â”‚ metrics.successful_enhancements += 1   # Now: 1                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ STEP 7: Validate Enhanced Script (lines 185-190, 202-232)          â”‚  â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚
â”‚  â”‚ validation_result = _validate_enhanced_script(enhanced, original)   â”‚  â”‚
â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚ Checks:                                                             â”‚  â”‚
â”‚  â”‚ 1. Word count: 20-200 words                                        â”‚  â”‚
â”‚  â”‚    enhanced.split() = 24 words âœ“                                   â”‚  â”‚
â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚ 2. Length ratio: Â±50% of original                                  â”‚  â”‚
â”‚  â”‚    len(enhanced)/len(original) = 140/50 = 2.8x âœ— FAIL!           â”‚  â”‚
â”‚  â”‚    (But this is expected - AI is meant to expand)                  â”‚  â”‚
â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚ 3. Not empty                                                        â”‚  â”‚
â”‚  â”‚    enhanced.strip() = "Let's explore..." âœ“                         â”‚  â”‚
â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚ 4. No markdown (BUG #2 HERE!)                                      â”‚  â”‚
â”‚  â”‚    Checks: ['**', '__', '##', '```', '[', ']', '(', ')']          â”‚  â”‚
â”‚  â”‚    Text: "Let's explore the essential concepts (foundation)"       â”‚  â”‚
â”‚  â”‚    Contains '(' and ')' âœ— FAIL! (INCORRECT - these are valid!)   â”‚  â”‚
â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚ Result: {'valid': False, 'reason': 'Contains markdown...'}         â”‚  â”‚
â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚ if not validation_result['valid']:                                 â”‚  â”‚
â”‚  â”‚     logger.warning(f"Validation failed: {reason}")                 â”‚  â”‚
â”‚  â”‚     self.metrics.failed_enhancements += 1      â—„â”€â”€ BUG #3         â”‚  â”‚
â”‚  â”‚     self.metrics.successful_enhancements -= 1  â—„â”€â”€ Can go negativeâ”‚  â”‚
â”‚  â”‚     return script  # Return ORIGINAL, not enhanced                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  Line 194: Return Enhanced (or Original if validation failed)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ return enhanced  # OR return script if validation failed      â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   SCRIPT GENERATION STAGE (CONTINUED)                       â”‚
â”‚                                                                             â”‚
â”‚  Line 86: Update Scene with Narration                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ scene.narration = narration                                   â”‚         â”‚
â”‚  â”‚ # Either enhanced OR original (if validation failed)          â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                             â”‚
â”‚  Lines 102-115: Log Final Metrics Summary                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ AI Usage Metrics:                                             â”‚         â”‚
â”‚  â”‚ â€¢ API calls: 10                                               â”‚         â”‚
â”‚  â”‚ â€¢ Input tokens: 4,500                                         â”‚         â”‚
â”‚  â”‚ â€¢ Output tokens: 1,350                                        â”‚         â”‚
â”‚  â”‚ â€¢ Estimated cost: $0.0338                                     â”‚         â”‚
â”‚  â”‚ â€¢ Successful: 8                                               â”‚         â”‚
â”‚  â”‚ â€¢ Failed: 2                                                   â”‚         â”‚
â”‚  â”‚ â€¢ Success rate: 80%                                           â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                             â”‚
â”‚  Return StageResult with metadata including ai_usage_metrics               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   PIPELINE ORCHESTRATOR (CONTINUES)                         â”‚
â”‚                                                                             â”‚
â”‚  Update context with stage artifacts:                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ context["video_config"] = video_config (with enhanced scenes) â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                             â”‚
â”‚  Proceed to next stages:                                                   â”‚
â”‚  â†’ AudioStage (generate TTS from enhanced narration)                       â”‚
â”‚  â†’ VideoStage (create visuals)                                             â”‚
â”‚  â†’ OutputStage (package final video)                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Key Data Transformations

### Scene Object Structure
```python
SceneConfig(
    scene_id="scene_001",
    scene_type="list",
    narration="",  # â† Populated by ScriptStage
    visual_content={  # â† Available but NOT used (BUG #1)
        "header": "Key Concepts",
        "items": ["Concept 1", "Concept 2", "Concept 3"]
    },
    voice="male",
    min_duration=3.0,
    max_duration=15.0
)
```

### Enhanced Context (Current - BUGGY)
```python
enhanced_context = {
    'scene_position': 0,
    'total_scenes': 10,
    # Missing: 'header', 'items', etc. from visual_content
}
```

### Enhanced Context (Fixed)
```python
enhanced_context = {
    'scene_position': 0,
    'total_scenes': 10,
    'header': 'Key Concepts',  # â† Now included!
    'items': ['Concept 1', 'Concept 2', 'Concept 3']
}
```

## Cost Breakdown (Example 10-Scene Video)

```
Scene 1 (opening):  Input: 500t, Output: 150t â†’ $0.00375
Scene 2:            Input: 450t, Output: 130t â†’ $0.00330
Scene 3:            Input: 480t, Output: 140t â†’ $0.00354
Scene 4:            Input: 420t, Output: 120t â†’ $0.00306
Scene 5:            Input: 510t, Output: 160t â†’ $0.00393
Scene 6:            Input: 440t, Output: 125t â†’ $0.00319
Scene 7:            Input: 470t, Output: 135t â†’ $0.00343
Scene 8:            Input: 490t, Output: 145t â†’ $0.00364
Scene 9 (penultimate): Input: 460t, Output: 128t â†’ $0.00330
Scene 10 (final):   Input: 520t, Output: 165t â†’ $0.00404

Total: 4,740 input tokens, 1,398 output tokens
Cost: $0.0342 (~3.4 cents per video)
```

## Error Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI Enhancement Request                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ API Key Valid? â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
             â”‚       â”‚
          NO â”‚       â”‚ YES
             â”‚       â”‚
             â–¼       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Raise   â”‚   â”‚  Call Claude API â”‚
    â”‚  Error   â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
                        â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ API Success?  â”‚
                â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
                    â”‚       â”‚
                 NO â”‚       â”‚ YES
                    â”‚       â”‚
                    â–¼       â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Log Warningâ”‚   â”‚  Validate   â”‚
         â”‚ Return     â”‚   â”‚  Response   â”‚
         â”‚ Original   â”‚   â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Valid Response?â”‚
                    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
                        â”‚        â”‚
                     NO â”‚        â”‚ YES
                        â”‚        â”‚
                        â–¼        â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Return     â”‚  â”‚ Return     â”‚
              â”‚ Original   â”‚  â”‚ Enhanced   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Metrics Flow

```
AIUsageMetrics Instance (per ScriptGenerationStage)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ total_api_calls: 0                          â”‚
â”‚ total_input_tokens: 0                       â”‚
â”‚ total_output_tokens: 0                      â”‚
â”‚ total_cost_usd: 0.0                         â”‚
â”‚ successful_enhancements: 0                  â”‚
â”‚ failed_enhancements: 0                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
         (after 10 scene enhancements)
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ total_api_calls: 10                         â”‚
â”‚ total_input_tokens: 4,740                   â”‚
â”‚ total_output_tokens: 1,398                  â”‚
â”‚ total_cost_usd: 0.0342                      â”‚
â”‚ successful_enhancements: 8                  â”‚
â”‚ failed_enhancements: 2                      â”‚
â”‚                                             â”‚
â”‚ get_summary() returns:                      â”‚
â”‚ {                                           â”‚
â”‚   "api_calls": 10,                          â”‚
â”‚   "input_tokens": 4740,                     â”‚
â”‚   "output_tokens": 1398,                    â”‚
â”‚   "estimated_cost_usd": 0.0342,            â”‚
â”‚   "successful": 8,                          â”‚
â”‚   "failed": 2,                              â”‚
â”‚   "success_rate": 80.0                      â”‚
â”‚ }                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
