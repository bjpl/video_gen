{% extends "base.html" %}

{% block content %}
<div class="max-w-5xl mx-auto" x-data="unifiedCreator()" x-init="init(); $cleanup && $cleanup(() => destroy())" @beforeunload.window="destroy()">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Create Video</h1>
        <p class="text-gray-600">Professional video generation in 4 simple steps</p>
    </div>

    <!-- Status Messages -->
    <div x-data="{ show: false, message: '', type: 'success' }"
         @show-message.window="show = true; message = $event.detail.message; type = $event.detail.type; setTimeout(() => show = false, 5000)"
         x-show="show"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform translate-y-2"
         x-transition:enter-end="opacity-100 transform translate-y-0"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed top-20 right-6 z-50 max-w-md"
         style="display: none;">
        <div class="rounded-lg shadow-2xl p-4 border-2"
             :class="type === 'success' ? 'bg-green-50 border-green-200' : type === 'error' ? 'bg-red-50 border-red-200' : 'bg-blue-50 border-blue-200'">
            <div class="flex items-center gap-3">
                <div class="text-2xl" x-text="type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'"></div>
                <div class="flex-1">
                    <div class="font-semibold" :class="type === 'success' ? 'text-green-900' : type === 'error' ? 'text-red-900' : 'text-blue-900'" x-text="message"></div>
                </div>
                <button @click="show = false" class="text-gray-400 hover:text-gray-600">√ó</button>
            </div>
        </div>
    </div>

    <!-- Wizard Stepper -->
    <div class="bg-white rounded-lg shadow-lg mb-6 p-6">
        <div class="flex items-center justify-between">
            <template x-for="(stepInfo, index) in steps" :key="index">
                <div class="flex items-center" :class="index < steps.length - 1 ? 'flex-1' : ''">
                    <!-- Step Circle -->
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold transition-all duration-300"
                             :class="currentStep > index + 1 ? 'bg-green-500 text-white' : currentStep === index + 1 ? 'bg-blue-500 text-white scale-110' : 'bg-gray-300 text-gray-600'">
                            <span x-show="currentStep <= index + 1" x-text="index + 1"></span>
                            <svg x-show="currentStep > index + 1" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                        <div class="hidden md:block">
                            <div class="font-bold text-sm" :class="currentStep === index + 1 ? 'text-gray-900' : 'text-gray-500'" x-text="stepInfo.title"></div>
                            <div class="text-xs text-gray-500" x-text="stepInfo.subtitle"></div>
                        </div>
                    </div>
                    <!-- Connector Line -->
                    <div x-show="index < steps.length - 1" class="flex-1 h-1 mx-4 rounded-full transition-all duration-500"
                         :class="currentStep > index + 1 ? 'bg-green-500' : 'bg-gray-300'"></div>
                </div>
            </template>
        </div>
    </div>

    <!-- Main Content Card -->
    <div class="bg-white rounded-lg shadow-lg p-6">
        <!-- Step 1: Input -->
        <div x-show="currentStep === 1" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform translate-x-4" x-transition:enter-end="opacity-100 transform translate-x-0">
            <!-- Dynamic title based on method -->
            <h2 class="text-2xl font-bold mb-4">
                <span x-show="!inputMethod">üì• Choose Input Source</span>
                <span x-show="inputMethod === 'document'">üìÑ Document Input</span>
                <span x-show="inputMethod === 'youtube'">üì∫ YouTube Video Input</span>
                <span x-show="inputMethod === 'yaml'">üìã YAML Configuration</span>
            </h2>

            <!-- Show input type selector ONLY if no method specified -->
            <div x-show="showInputTypeSelector" class="grid md:grid-cols-3 gap-4 mb-6">
                <button @click="inputType = 'url'; inputError = ''" type="button"
                        class="p-6 rounded-lg border-2 transition-all hover:shadow-lg"
                        :class="inputType === 'url' ? 'border-blue-500 bg-blue-50' : 'border-gray-300 hover:border-blue-300'">
                    <div class="text-4xl mb-3">üîó</div>
                    <div class="font-bold text-lg mb-1">URL</div>
                    <div class="text-sm text-gray-600">Website or article</div>
                </button>

                <button @click="inputType = 'file'; inputError = ''" type="button"
                        class="p-6 rounded-lg border-2 transition-all hover:shadow-lg"
                        :class="inputType === 'file' ? 'border-blue-500 bg-blue-50' : 'border-gray-300 hover:border-blue-300'">
                    <div class="text-4xl mb-3">üìÑ</div>
                    <div class="font-bold text-lg mb-1">File</div>
                    <div class="text-sm text-gray-600">Upload document</div>
                </button>

                <button @click="inputType = 'text'; inputError = ''" type="button"
                        class="p-6 rounded-lg border-2 transition-all hover:shadow-lg"
                        :class="inputType === 'text' ? 'border-blue-500 bg-blue-50' : 'border-gray-300 hover:border-blue-300'">
                    <div class="text-4xl mb-3">‚úçÔ∏è</div>
                    <div class="font-bold text-lg mb-1">Text</div>
                    <div class="text-sm text-gray-600">Paste or type</div>
                </button>
            </div>

            <!-- Method-specific help text -->
            <div x-show="inputMethod" class="mb-4 p-4 bg-blue-50 border-l-4 border-blue-500 rounded">
                <p class="text-sm text-blue-900" x-show="inputMethod === 'document'">
                    üìò Upload a document (PDF, DOCX, TXT, MD) or paste text to automatically generate a video.
                </p>
                <p class="text-sm text-blue-900" x-show="inputMethod === 'youtube'">
                    üé• Enter a YouTube URL and we'll extract the transcript to create a summary video.
                </p>
                <p class="text-sm text-blue-900" x-show="inputMethod === 'yaml'">
                    ‚öôÔ∏è Upload a YAML configuration file with your video structure and settings.
                </p>
            </div>

            <!-- Input Fields -->
            <div class="space-y-4">
                <!-- URL Input - WITH REAL-TIME VALIDATION -->
                <div x-show="inputType === 'url'">
                    {% include 'components/validation-feedback.html' %}
                </div>

                <!-- File Upload - NEW MODERN DRAG-DROP COMPONENT -->
                <div x-show="inputType === 'file'"
                     @file-ready.window="handleFileReady($event)">
                    {% include 'components/drag-drop-zone.html' %}
                </div>

                <!-- Text Input -->
                <div x-show="inputType === 'text'">
                    <label for="input-text-content" class="block text-sm font-medium text-gray-700 mb-2">Enter Content</label>
                    <textarea id="input-text-content" x-model="inputData.text" @input="validateInput()"
                              rows="8"
                              placeholder="Paste or type your content here..."
                              aria-label="Content text"
                              class="w-full px-4 py-3 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"
                              :class="inputError ? 'border-red-500' : 'border-gray-300'"></textarea>
                </div>

                <!-- Error Message -->
                <div x-show="inputError" class="bg-red-50 border-2 border-red-200 rounded-lg p-3 flex items-start gap-2">
                    <span class="text-red-500 text-xl">‚ö†Ô∏è</span>
                    <div class="flex-1 text-red-700 text-sm" x-text="inputError"></div>
                </div>
            </div>

            <!-- Navigation (hidden for file upload since drag-drop has its own Continue button) -->
            <div x-show="inputType !== 'file'" class="flex justify-end gap-3 mt-6">
                <button @click="nextStep()" :disabled="!isStepValid(1)"
                        class="px-6 py-3 rounded-lg font-semibold transition-all"
                        :class="isStepValid(1) ? 'bg-blue-500 text-white hover:bg-blue-600 shadow-md hover:shadow-lg' : 'bg-gray-300 text-gray-500 cursor-not-allowed'">
                    Next: Configure ‚Üí
                </button>
            </div>
        </div>

        <!-- Step 2: Configure -->
        <div x-show="currentStep === 2" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform translate-x-4" x-transition:enter-end="opacity-100 transform translate-x-0">
            <h2 class="text-2xl font-bold mb-4">‚öôÔ∏è Configure Video</h2>

            <!-- Preset Selection -->
            <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-yellow-200 rounded-xl p-4 mb-6">
                <h3 class="font-bold text-gray-900 mb-3 flex items-center gap-2">
                    <span class="text-xl">‚ö°</span>
                    Quick Presets
                </h3>
                <div class="grid md:grid-cols-3 gap-3">
                    <button @click="applyPreset('corporate')" type="button"
                            class="p-4 bg-white hover:bg-yellow-50 border-2 rounded-lg text-left transition-all hover:shadow-md"
                            :class="selectedPreset === 'corporate' ? 'border-blue-500 ring-2 ring-blue-200' : 'border-yellow-200'">
                        <div class="text-2xl mb-2">üíº</div>
                        <div class="font-bold mb-1">Corporate</div>
                        <div class="text-xs text-gray-600">Professional business videos</div>
                    </button>

                    <button @click="applyPreset('creative')" type="button"
                            class="p-4 bg-white hover:bg-yellow-50 border-2 rounded-lg text-left transition-all hover:shadow-md"
                            :class="selectedPreset === 'creative' ? 'border-blue-500 ring-2 ring-blue-200' : 'border-yellow-200'">
                        <div class="text-2xl mb-2">üé®</div>
                        <div class="font-bold mb-1">Creative</div>
                        <div class="text-xs text-gray-600">Engaging tutorial content</div>
                    </button>

                    <button @click="applyPreset('educational')" type="button"
                            class="p-4 bg-white hover:bg-yellow-50 border-2 rounded-lg text-left transition-all hover:shadow-md"
                            :class="selectedPreset === 'educational' ? 'border-blue-500 ring-2 ring-blue-200' : 'border-yellow-200'">
                        <div class="text-2xl mb-2">üéì</div>
                        <div class="font-bold mb-1">Educational</div>
                        <div class="text-xs text-gray-600">Structured learning materials</div>
                    </button>
                </div>
            </div>

            <!-- Configuration Form -->
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Video ID -->
                <div>
                    <label for="config-video-id" class="block text-sm font-medium text-gray-700 mb-2">Video ID</label>
                    <input type="text" id="config-video-id" x-model="config.videoId" @input="validateConfig()"
                           placeholder="my-video"
                           aria-label="Video identifier"
                           class="w-full px-4 py-2 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           :class="configErrors.videoId ? 'border-red-500' : 'border-gray-300'">
                    <div x-show="configErrors.videoId" class="text-red-600 text-xs mt-1" x-text="configErrors.videoId"></div>
                </div>

                <!-- Duration -->
                <div>
                    <label for="config-duration" class="block text-sm font-medium text-gray-700 mb-2">Duration (seconds)</label>
                    <input type="number" id="config-duration" x-model.number="config.duration" @input="validateConfig(); updateCostEstimate()"
                           min="30" max="600"
                           aria-label="Video duration in seconds"
                           class="w-full px-4 py-2 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 border-gray-300">
                    <div class="text-xs text-gray-500 mt-1">Recommended: 120-300 seconds</div>
                </div>

                <!-- NEW: Video Mode Selector (Single vs Set) -->
                <div class="md:col-span-2 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3 flex items-center gap-2">
                        <span>üé¨</span>
                        Video Output Mode
                    </h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <button @click="config.videoMode = 'single'"
                                type="button"
                                :class="config.videoMode === 'single' ? 'bg-blue-50 border-blue-500 ring-2 ring-blue-200' : 'bg-white border-gray-300 hover:border-blue-300'"
                                class="p-4 border-2 rounded-lg text-left transition-all">
                            <div class="text-2xl mb-2">üé¨</div>
                            <div class="font-bold mb-1">Single Video</div>
                            <div class="text-xs text-gray-600">Create one complete video from the entire document</div>
                        </button>
                        <button @click="config.videoMode = 'set'"
                                type="button"
                                :class="config.videoMode === 'set' ? 'bg-blue-50 border-blue-500 ring-2 ring-blue-200' : 'bg-white border-gray-300 hover:border-blue-300'"
                                class="p-4 border-2 rounded-lg text-left transition-all">
                            <div class="text-2xl mb-2">üìö</div>
                            <div class="font-bold mb-1">Video Set</div>
                            <div class="text-xs text-gray-600">Split document into multiple videos (by H2 headings)</div>
                        </button>
                    </div>
                    <!-- Video count selector for sets -->
                    <div x-show="config.videoMode === 'set'"
                         x-transition
                         class="mt-4 p-4 bg-gray-50 rounded-lg">
                        <label for="video-count" class="block text-sm font-medium text-gray-700 mb-2">Number of Videos</label>
                        <input type="number"
                               id="video-count"
                               x-model.number="config.videoCount"
                               min="2"
                               max="10"
                               class="w-32 px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-2">Document will be split into <span class="font-semibold" x-text="config.videoCount"></span> videos</p>
                    </div>
                </div>

                <!-- NEW: Multi-Language Selector Component -->
                <div class="md:col-span-2">
                    {% include 'components/multi-language-selector.html' %}
                </div>

                <!-- NEW: Multi-Voice Selector Component -->
                <div class="md:col-span-2">
                    {% include 'components/multi-voice-selector.html' %}
                </div>

                <!-- Color Theme -->
                <div>
                    <label for="config-color" class="block text-sm font-medium text-gray-700 mb-2">Color Theme</label>
                    <select id="config-color" x-model="config.color"
                            aria-label="Color theme selection"
                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="blue">Blue (Corporate)</option>
                        <option value="green">Green (Educational)</option>
                        <option value="purple">Purple (Creative)</option>
                        <option value="cyan">Cyan (Technical)</option>
                    </select>
                </div>

                <!-- AI Narration Info (ALWAYS ENABLED - No toggle) -->
                <div class="md:col-span-2">
                    <div class="bg-gradient-to-r from-purple-50 to-blue-50 border-2 border-purple-200 rounded-lg p-4">
                        <div class="flex items-center gap-3">
                            <div class="text-2xl">ü§ñ</div>
                            <div class="flex-1">
                                <div class="font-semibold text-gray-900">AI Narration Enhancement</div>
                                <div class="text-sm text-gray-600">Powered by Claude Sonnet 4.5 - Always Enabled</div>
                            </div>
                            <div class="px-3 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded-full">ACTIVE</div>
                        </div>
                        <div class="text-xs text-gray-500 mt-2">All videos include AI-powered narration for superior quality</div>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="flex justify-between gap-3 mt-6">
                <button @click="previousStep()"
                        class="px-6 py-3 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300 transition-all">
                    ‚Üê Back
                </button>
                <button @click="nextStep()" :disabled="!isStepValid(2)"
                        class="px-6 py-3 rounded-lg font-semibold transition-all"
                        :class="isStepValid(2) ? 'bg-blue-500 text-white hover:bg-blue-600 shadow-md hover:shadow-lg' : 'bg-gray-300 text-gray-500 cursor-not-allowed'">
                    Next: Review ‚Üí
                </button>
            </div>
        </div>

        <!-- Step 3: Review -->
        <div x-show="currentStep === 3" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform translate-x-4" x-transition:enter-end="opacity-100 transform translate-x-0">
            <h2 class="text-2xl font-bold mb-4">üëÄ Review Configuration</h2>

            <!-- NEW: Preview Panel Component -->
            <div class="mb-6">
                {% include 'components/preview-panel.html' %}
            </div>

            <!-- Cost Estimate -->
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-xl p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-bold text-gray-900 flex items-center gap-2">
                        <span class="text-xl">üí∞</span>
                        Estimated Cost
                    </h3>
                    <div class="text-3xl font-bold text-green-700" x-text="'$' + costEstimate.total.toFixed(4)"></div>
                </div>
                <div class="space-y-2">
                    <template x-for="item in costEstimate.breakdown" :key="item.item">
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-700" x-text="item.details"></span>
                            <span class="font-semibold text-gray-900" x-text="'$' + item.cost.toFixed(4)"></span>
                        </div>
                    </template>
                </div>
                <div class="mt-4 pt-4 border-t border-green-300 text-xs text-gray-600">
                    <div>üí° TTS is always free (Edge-TTS)</div>
                    <div>ü§ñ AI narration enhancement always enabled for superior quality</div>
                </div>
            </div>

            <!-- Configuration Summary -->
            <div class="grid md:grid-cols-2 gap-4 mb-6">
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="text-sm font-semibold text-gray-700 mb-2">üì• Input</div>
                    <div class="text-sm text-gray-900" x-text="inputType === 'url' ? 'URL: ' + inputData.url : inputType === 'file' ? 'File: ' + inputData.fileName : 'Custom Text'"></div>
                </div>

                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="text-sm font-semibold text-gray-700 mb-2">üÜî Video ID</div>
                    <div class="text-sm text-gray-900" x-text="config.videoId"></div>
                </div>

                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="text-sm font-semibold text-gray-700 mb-2">‚è±Ô∏è Duration</div>
                    <div class="text-sm text-gray-900" x-text="config.duration + ' seconds'"></div>
                </div>

                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="text-sm font-semibold text-gray-700 mb-2">üåç Languages</div>
                    <div class="text-sm text-gray-900" x-text="config.languageMode === 'single' ? 'Single Language' : config.targetLanguages.length + ' languages'"></div>
                </div>

                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="text-sm font-semibold text-gray-700 mb-2">üé§ Voice</div>
                    <div class="text-sm text-gray-900" x-text="config.primaryVoice.split('-')[2]"></div>
                </div>

                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="text-sm font-semibold text-gray-700 mb-2">üé¨ Video Mode</div>
                    <div class="text-sm text-gray-900" x-text="config.videoMode === 'single' ? 'Single Video' : 'Video Set (' + config.videoCount + ' videos)'"></div>
                </div>

                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="text-sm font-semibold text-gray-700 mb-2">ü§ñ AI Narration</div>
                    <div class="text-sm text-gray-900 flex items-center gap-2">
                        <span class="px-2 py-0.5 bg-green-100 text-green-800 text-xs font-semibold rounded">ENABLED</span>
                        <span>Claude Sonnet 4.5</span>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="flex justify-between gap-3 mt-6">
                <button @click="previousStep()"
                        class="px-6 py-3 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300 transition-all">
                    ‚Üê Back
                </button>
                <button @click="nextStep()"
                        class="px-6 py-3 rounded-lg font-semibold bg-blue-500 text-white hover:bg-blue-600 shadow-md hover:shadow-lg transition-all">
                    Next: Generate ‚Üí
                </button>
            </div>
        </div>

        <!-- Step 4: Generate -->
        <div x-show="currentStep === 4" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform translate-x-4" x-transition:enter-end="opacity-100 transform translate-x-0">
            <h2 class="text-2xl font-bold mb-4">üöÄ Generate Video</h2>

            <!-- NEW: Progress Indicator Component -->
            {% include 'components/progress-indicator.html' %}

            <!-- Generation Status (Legacy - kept for fallback) -->
            <div x-show="!generationComplete && !$store.appState.progress.isProcessing" class="space-y-4">
                <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-6 text-center">
                    <div class="text-6xl mb-4 animate-bounce">üé¨</div>
                    <div class="text-xl font-bold text-gray-900 mb-2">Generating Your Video...</div>
                    <div class="text-gray-600 mb-4">This may take a few minutes</div>

                    <!-- Progress Bar -->
                    <div class="w-full bg-gray-200 rounded-full h-4 mb-4">
                        <div class="bg-blue-500 h-4 rounded-full transition-all duration-500" :style="'width: ' + generationProgress + '%'"></div>
                    </div>

                    <div class="text-sm text-gray-600" x-text="generationStatus"></div>
                </div>
            </div>

            <!-- Success Message -->
            <div x-show="generationComplete" class="space-y-4">
                <div class="bg-green-50 border-2 border-green-200 rounded-xl p-6 text-center">
                    <div class="text-6xl mb-4">‚úÖ</div>
                    <div class="text-2xl font-bold text-green-900 mb-2">Video Generated Successfully!</div>
                    <div class="text-gray-600 mb-4">Your video is ready to view</div>

                    <div class="flex justify-center gap-4">
                        <a :href="'/progress#' + generatedJobId"
                           class="px-6 py-3 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 transition-all">
                            View Video
                        </a>
                        <button @click="reset()"
                                class="px-6 py-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition-all">
                            Create Another
                        </button>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <div x-show="!generationStarted" class="flex justify-between gap-3 mt-6">
                <button @click="previousStep()"
                        class="px-6 py-3 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300 transition-all">
                    ‚Üê Back
                </button>
                <button @click="startGeneration()"
                        class="px-6 py-3 rounded-lg font-semibold bg-green-500 text-white hover:bg-green-600 shadow-md hover:shadow-lg transition-all">
                    üöÄ Start Generation
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function unifiedCreator() {
    return {
        // Step management
        currentStep: 1,
        steps: [
            { title: 'Input', subtitle: 'Choose source' },
            { title: 'Configure', subtitle: 'Video settings' },
            { title: 'Review', subtitle: 'Check details' },
            { title: 'Generate', subtitle: 'Create video' }
        ],

        // Input data
        inputType: 'url',
        inputMethod: null, // Tracks which home page card was clicked (document/youtube/yaml)
        showInputTypeSelector: true, // Hide selector when coming from home page
        inputData: {
            url: '',
            file: null,
            fileName: '',
            fileContent: '', // Actual file content (read via FileReader)
            text: ''
        },
        inputError: '',
        isReadingFile: false, // Track async file reading state

        // Configuration
        config: {
            videoId: '',
            duration: 120,
            videoMode: 'single', // 'single' or 'set'
            videoCount: 1, // Number of videos in set
            languageMode: 'single',
            targetLanguages: ['en'],
            primaryVoice: 'en-US-JennyNeural',
            color: 'blue',
            useAI: true // ALWAYS TRUE - AI narration always enabled
        },
        configErrors: {},
        selectedPreset: null,

        // Available options
        availableLanguages: [
            { code: 'en', name: 'English' },
            { code: 'es', name: 'Spanish' },
            { code: 'fr', name: 'French' },
            { code: 'de', name: 'German' }
        ],

        // Cost estimation
        costEstimate: {
            total: 0,
            breakdown: []
        },

        // Generation
        generationStarted: false,
        generationProgress: 0,
        generationStatus: 'Initializing...',
        generationComplete: false,
        generatedJobId: null,

        // Security - AbortController for cleanup (FIX C2: Memory leak prevention)
        pollAbortController: null,
        retryCount: 0,
        maxRetries: 3,

        init() {
            // Read method from URL query parameter
            const urlParams = new URLSearchParams(window.location.search);
            const method = urlParams.get('method');

            // Map home page methods to input types and customize UI
            if (method === 'document') {
                this.inputType = 'file'; // Document upload
                this.inputMethod = 'document';
                this.showInputTypeSelector = false; // Hide selector
            } else if (method === 'youtube') {
                this.inputType = 'url'; // YouTube URL
                this.inputMethod = 'youtube';
                this.showInputTypeSelector = false; // Hide selector
            } else if (method === 'wizard') {
                // Redirect to builder for full scene-by-scene control
                window.location.href = '/builder';
                return;
            } else if (method === 'yaml') {
                this.inputType = 'file'; // YAML file upload
                this.inputMethod = 'yaml';
                this.showInputTypeSelector = false; // Hide selector
            }

            // Initialize cost estimator
            if (window.CostEstimator) {
                this.costEstimator = new window.CostEstimator();
            }

            // Initialize validator
            if (window.FormValidator) {
                this.validator = new window.FormValidator();
            }

            // Load presets
            if (window.PRESET_PACKAGES) {
                this.presets = window.PRESET_PACKAGES;
            }
        },

        nextStep() {
            if (this.isStepValid(this.currentStep)) {
                this.currentStep++;
                if (this.currentStep === 3) {
                    this.updateCostEstimate();
                }
            }
        },

        previousStep() {
            if (this.currentStep > 1) {
                this.currentStep--;
            }
        },

        /**
         * Handle file-ready event from drag-drop component
         * Receives file data and advances to next step
         */
        handleFileReady(event) {
            console.log('[UnifiedCreator] File ready event received:', event.detail);

            if (event.detail && event.detail.file) {
                // Update parent state with file data
                this.inputData.file = event.detail.file;
                this.inputData.fileName = event.detail.file.name;

                // Store file content (we'll read it when generating)
                this.inputData.fileContent = 'file-uploaded';

                // Clear any errors
                this.inputError = '';

                // Auto-advance to next step
                console.log('[UnifiedCreator] Advancing to step 2');
                this.currentStep = 2;
            }
        },

        isStepValid(step) {
            switch(step) {
                case 1: // Input validation
                    return this.inputError === '' && this.hasValidInput();
                case 2: // Config validation
                    return Object.keys(this.configErrors).length === 0 && this.config.videoId;
                case 3: // Review (always valid)
                    return true;
                default:
                    return false;
            }
        },

        hasValidInput() {
            // Don't allow proceeding while file is being read
            if (this.isReadingFile) return false;

            switch(this.inputType) {
                case 'url':
                    return this.inputData.url && this.inputData.url.trim().length > 0;
                case 'file':
                    // Check if drag-drop component has valid file OR legacy file upload
                    const dragDropValid = Alpine.store('appState')?.formData?.document?.isValid;
                    const legacyValid = this.inputData.file !== null && this.inputData.fileContent.length > 0;
                    return dragDropValid || legacyValid;
                case 'text':
                    return this.inputData.text && this.inputData.text.trim().length > 0;
                default:
                    return false;
            }
        },

        validateInput() {
            this.inputError = '';

            if (this.inputType === 'url' && this.validator) {
                const error = this.validator.validateField('url', this.inputData.url);
                if (error) {
                    this.inputError = error;
                }
            } else if (this.inputType === 'text' && this.inputData.text.trim().length < 10) {
                this.inputError = 'Text must be at least 10 characters';
            }
        },

        validateConfig() {
            this.configErrors = {};

            if (this.validator) {
                const videoIdError = this.validator.validateField('video_id', this.config.videoId);
                if (videoIdError) {
                    this.configErrors.videoId = videoIdError;
                }
            }
        },

        async handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type based on input method
            const allowedTypes = this.inputMethod === 'yaml'
                ? ['.yaml', '.yml']
                : ['.txt', '.md', '.pdf', '.docx'];

            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            if (!allowedTypes.some(ext => fileExtension === ext)) {
                this.inputError = `Invalid file type. Allowed: ${allowedTypes.join(', ')}`;
                return;
            }

            // Check file size (max 10MB for documents, 1MB for YAML)
            const maxSize = this.inputMethod === 'yaml' ? 1 * 1024 * 1024 : 10 * 1024 * 1024;
            if (file.size > maxSize) {
                const maxMB = maxSize / (1024 * 1024);
                this.inputError = `File too large. Maximum size: ${maxMB}MB`;
                return;
            }

            // Store file metadata immediately
            this.inputData.file = file;
            this.inputData.fileName = file.name;
            this.inputError = '';
            this.isReadingFile = true;

            try {
                // Handle binary files (PDF, DOCX) differently from text files
                if (fileExtension === '.pdf' || fileExtension === '.docx') {
                    // For binary files, we'll send as base64
                    const content = await this.readFileAsBase64(file);
                    this.inputData.fileContent = content;
                    this.inputData.fileType = fileExtension.substring(1); // 'pdf' or 'docx'
                } else {
                    // For text files (txt, md, yaml, yml), read as text
                    const content = await this.readFileAsText(file);

                    // Validate content isn't empty
                    if (!content || content.trim().length === 0) {
                        this.inputError = 'File is empty';
                        this.inputData.file = null;
                        this.inputData.fileName = '';
                        this.inputData.fileContent = '';
                        return;
                    }

                    // For YAML, do basic syntax validation
                    if (this.inputMethod === 'yaml') {
                        if (!this.isValidYamlSyntax(content)) {
                            this.inputError = 'Invalid YAML syntax. Please check your file.';
                            this.inputData.file = null;
                            this.inputData.fileName = '';
                            this.inputData.fileContent = '';
                            return;
                        }
                    }

                    this.inputData.fileContent = content;
                    this.inputData.fileType = 'text';
                }

                console.log(`File read successfully: ${file.name} (${this.inputData.fileContent.length} chars)`);
            } catch (error) {
                console.error('File read error:', error);
                this.inputError = 'Failed to read file: ' + error.message;
                this.inputData.file = null;
                this.inputData.fileName = '';
                this.inputData.fileContent = '';
            } finally {
                this.isReadingFile = false;
            }
        },

        // Read file as text using FileReader API
        readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error('Failed to read file'));
                reader.readAsText(file, 'UTF-8');
            });
        },

        // Read file as base64 for binary files (PDF, DOCX)
        readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    // Remove data URL prefix to get pure base64
                    const base64 = e.target.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = (e) => reject(new Error('Failed to read file'));
                reader.readAsDataURL(file);
            });
        },

        // Basic YAML syntax validation
        isValidYamlSyntax(content) {
            // Check for common YAML structure indicators
            const lines = content.split('\n');
            let hasValidStructure = false;

            for (const line of lines) {
                const trimmed = line.trim();
                // Skip empty lines and comments
                if (!trimmed || trimmed.startsWith('#')) continue;

                // Check for key-value pairs or list items
                if (trimmed.includes(':') || trimmed.startsWith('-')) {
                    hasValidStructure = true;
                    break;
                }
            }

            return hasValidStructure;
        },

        applyPreset(presetId) {
            this.selectedPreset = presetId;

            if (this.presets && this.presets[presetId]) {
                const preset = this.presets[presetId];
                const cfg = preset.config;

                this.config.languageMode = cfg.languageMode;
                this.config.targetLanguages = cfg.targetLanguages;
                this.config.primaryVoice = cfg.primaryVoice;
                this.config.color = cfg.color;
                this.config.duration = cfg.duration;
                this.config.useAI = cfg.useAI;

                this.updateCostEstimate();

                window.dispatchEvent(new CustomEvent('show-message', {
                    detail: { message: `Applied ${preset.name} preset`, type: 'success' }
                }));
            }
        },

        updateCostEstimate() {
            if (!this.costEstimator) return;

            const estimate = this.costEstimator.estimateVideoSetCost({
                use_ai_narration: this.config.useAI,
                target_languages: this.config.targetLanguages,
                translation_method: 'claude',
                estimatedScenesPerVideo: Math.ceil(this.config.duration / 30),
                videos: [{ scenes: [] }]
            });

            this.costEstimate = estimate;
        },

        /**
         * Start video generation with CSRF protection and error retry
         * FIX C1: Added CSRF token to all POST requests
         * FIX M2: Added retry logic for network errors
         */
        async startGeneration() {
            console.log('startGeneration called');
            this.generationStarted = true;
            this.generationProgress = 0;
            this.generationStatus = 'Preparing video generation...';
            this.retryCount = 0;

            try {
                let endpoint = '';
                let payload = {};

                console.log('Input method:', this.inputMethod);
                console.log('Input type:', this.inputType);

                // Determine which API endpoint to use based on input method
                if (this.inputMethod === 'youtube' || (this.inputType === 'url' && this.inputData.url.includes('youtube'))) {
                    endpoint = '/api/parse/youtube';
                    payload = {
                        url: window.securityUtils ? window.securityUtils.sanitizeUrl(this.inputData.url) : this.inputData.url,
                        duration: this.config.duration,
                        accent_color: this.config.color
                    };
                } else if (this.inputMethod === 'yaml') {
                    // YAML configuration - send to YAML-specific endpoint
                    endpoint = '/api/parse/yaml';
                    payload = {
                        content: this.inputData.fileContent,
                        filename: window.securityUtils ? window.securityUtils.sanitizeFilename(this.inputData.fileName) : this.inputData.fileName,
                        accent_color: this.config.color,
                        voice: this.config.primaryVoice
                    };
                } else if (this.inputMethod === 'document' || this.inputType === 'file' || this.inputType === 'text') {
                    endpoint = '/api/parse/document';

                    // Determine content source: text input, file content, or URL
                    let content = '';
                    if (this.inputType === 'text') {
                        content = this.inputData.text;
                    } else if (this.inputType === 'file') {
                        content = this.inputData.fileContent;
                    } else if (this.inputType === 'url') {
                        content = window.securityUtils ? window.securityUtils.sanitizeUrl(this.inputData.url) : this.inputData.url;
                    }

                    payload = {
                        content: content,
                        filename: this.inputData.fileName ? (window.securityUtils ? window.securityUtils.sanitizeFilename(this.inputData.fileName) : this.inputData.fileName) : null,
                        file_type: this.inputData.fileType || 'text',
                        accent_color: this.config.color,
                        voice: this.config.primaryVoice,
                        video_count: 1,
                        generate_set: false
                    };
                } else {
                    throw new Error('Unknown input method');
                }

                console.log('Calling endpoint:', endpoint);

                this.generationProgress = 20;
                this.generationStatus = 'Processing content...';

                // FIX C1: Use secure fetch with CSRF token
                const response = await this._securePost(endpoint, payload);

                this.generationProgress = 40;
                this.generationStatus = 'Generating video...';

                if (response.ok) {
                    const result = await response.json();
                    this.generatedJobId = result.task_id;

                    // Poll for completion with abort controller
                    await this.pollJobStatus(result.task_id);
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Generation failed');
                }
            } catch (error) {
                // FIX M2: Categorize and handle errors with retry
                const errorType = this._categorizeError(error);

                if (errorType === 'network' && this.retryCount < this.maxRetries) {
                    this.retryCount++;
                    console.log(`Retrying (${this.retryCount}/${this.maxRetries})...`);
                    this.generationStatus = `Network error, retrying (${this.retryCount}/${this.maxRetries})...`;
                    await this._delay(2000 * this.retryCount);
                    return this.startGeneration();
                }

                console.error('Generation error:', error);
                this.generationProgress = 0;
                this.generationStatus = this._getUserFriendlyError(errorType, error);
                this.generationStarted = false;
                window.dispatchEvent(new CustomEvent('show-message', {
                    detail: { message: this._getUserFriendlyError(errorType, error), type: 'error' }
                }));
            }
        },

        /**
         * Secure POST request with CSRF token
         * FIX C1: All POST requests include CSRF token
         */
        async _securePost(url, payload) {
            // Use securityUtils if available, otherwise fallback
            if (window.securityUtils) {
                return window.securityUtils.secureFetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
            }

            // Fallback: try to get CSRF token from meta tag
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
            const headers = { 'Content-Type': 'application/json' };
            if (csrfToken) {
                headers['X-CSRF-Token'] = csrfToken;
            }

            return fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(payload)
            });
        },

        /**
         * Categorize error for handling
         * FIX M2: Error categorization
         */
        _categorizeError(error) {
            if (error.name === 'AbortError') return 'cancelled';
            if (error.name === 'TypeError' || error.message.includes('network') || error.message.includes('fetch')) return 'network';
            if (error.message.includes('CSRF')) return 'csrf';
            if (error.message.includes('timeout')) return 'timeout';
            return 'unknown';
        },

        /**
         * Get user-friendly error message
         * FIX M2: Better error messages
         */
        _getUserFriendlyError(errorType, error) {
            const messages = {
                'network': 'Network error. Please check your connection and try again.',
                'csrf': 'Session expired. Please refresh the page and try again.',
                'timeout': 'Request timed out. Please try again.',
                'cancelled': 'Request was cancelled.',
                'unknown': 'Generation failed: ' + (error.message || 'Unknown error')
            };
            return messages[errorType] || messages['unknown'];
        },

        /**
         * Delay helper for retry logic
         */
        _delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        },

        /**
         * Poll job status with proper cleanup
         * FIX C2: Uses AbortController for proper cleanup on component destruction
         */
        async pollJobStatus(taskId) {
            const maxAttempts = 60; // 2 minutes max
            let attempts = 0;

            // Create abort controller for this polling session
            this.pollAbortController = new AbortController();
            const signal = this.pollAbortController.signal;

            while (attempts < maxAttempts && !signal.aborted) {
                try {
                    // Use abort signal for fetch
                    const response = await fetch(`/api/tasks/${taskId}`, { signal });

                    if (signal.aborted) {
                        console.log('Polling aborted');
                        return;
                    }

                    if (response.ok) {
                        const status = await response.json();

                        this.generationProgress = status.progress || 50;
                        this.generationStatus = status.message || 'Processing...';

                        if (status.status === 'complete') {
                            this.generationProgress = 100;
                            this.generationStatus = 'Complete!';
                            this.generationComplete = true;
                            this._cleanupPolling();
                            window.dispatchEvent(new CustomEvent('show-message', {
                                detail: { message: 'Video generated successfully!', type: 'success' }
                            }));
                            return;
                        } else if (status.status === 'failed') {
                            this._cleanupPolling();
                            throw new Error(status.errors || 'Generation failed');
                        }
                    }
                } catch (error) {
                    // Don't log abort errors (expected during cleanup)
                    if (error.name !== 'AbortError') {
                        console.error('Polling error:', error);
                    } else {
                        return; // Exit cleanly on abort
                    }
                }

                // Abortable delay
                await this._abortableDelay(2000, signal);
                attempts++;
            }

            this._cleanupPolling();

            if (!signal.aborted) {
                throw new Error('Generation timeout');
            }
        },

        /**
         * Delay that can be aborted
         * FIX C2: Abortable timeout for clean cancellation
         */
        _abortableDelay(ms, signal) {
            return new Promise((resolve) => {
                const timeoutId = setTimeout(resolve, ms);
                signal.addEventListener('abort', () => {
                    clearTimeout(timeoutId);
                    resolve();
                }, { once: true });
            });
        },

        /**
         * Clean up polling resources
         * FIX C2: Proper resource cleanup
         */
        _cleanupPolling() {
            if (this.pollAbortController) {
                // Don't abort if already completed
                if (!this.generationComplete) {
                    this.pollAbortController.abort();
                }
                this.pollAbortController = null;
            }
        },

        /**
         * Reset component state and clean up resources
         * FIX C2: Added cleanup call to prevent memory leaks
         */
        reset() {
            // FIX C2: Clean up any active polling
            this._cleanupPolling();

            this.currentStep = 1;
            this.inputType = 'url';
            this.inputData = { url: '', file: null, fileName: '', fileContent: '', fileType: '', text: '' };
            this.inputError = '';
            this.isReadingFile = false;
            this.config = {
                videoId: '',
                duration: 120,
                languageMode: 'single',
                targetLanguages: ['en'],
                primaryVoice: 'en-US-JennyNeural',
                color: 'blue',
                useAI: false
            };
            this.configErrors = {};
            this.selectedPreset = null;
            this.generationStarted = false;
            this.generationProgress = 0;
            this.generationStatus = 'Initializing...';
            this.generationComplete = false;
            this.generatedJobId = null;
            this.retryCount = 0;
        },

        /**
         * Destroy/cleanup method for component removal
         * FIX C2: Called when component is removed from DOM
         */
        destroy() {
            this._cleanupPolling();

            // Clean up any global event listeners if needed
            if (window.securityUtils) {
                window.securityUtils.abortAllRequests();
            }
        }
    };
}
</script>
{% endblock %}
