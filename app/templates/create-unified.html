{% extends "base.html" %}

{% block content %}
<div class="max-w-5xl mx-auto" x-data="unifiedCreator()" x-init="init()" @beforeunload.window="destroy()">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Create Video</h1>
        <p class="text-gray-600">Professional video generation in 4 simple steps</p>
    </div>

    <!-- Status Messages -->
    <div x-data="{ show: false, message: '', type: 'success' }"
         @show-message.window="show = true; message = $event.detail.message; type = $event.detail.type; setTimeout(() => show = false, 5000)"
         x-show="show"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform translate-y-2"
         x-transition:enter-end="opacity-100 transform translate-y-0"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed top-20 right-6 z-50 max-w-md"
         style="display: none;">
        <div class="rounded-lg shadow-2xl p-4 border-2"
             :class="type === 'success' ? 'bg-green-50 border-green-200' : type === 'error' ? 'bg-red-50 border-red-200' : 'bg-blue-50 border-blue-200'">
            <div class="flex items-center gap-3">
                <div class="text-2xl" x-text="type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'"></div>
                <div class="flex-1">
                    <div class="font-semibold" :class="type === 'success' ? 'text-green-900' : type === 'error' ? 'text-red-900' : 'text-blue-900'" x-text="message"></div>
                </div>
                <button @click="show = false" class="text-gray-400 hover:text-gray-600">√ó</button>
            </div>
        </div>
    </div>

    <!-- Wizard Stepper -->
    <div class="bg-white rounded-lg shadow-lg mb-6 p-6">
        <div class="flex items-center justify-between">
            <template x-for="(stepInfo, index) in steps" :key="index">
                <div class="flex items-center" :class="index < steps.length - 1 ? 'flex-1' : ''">
                    <!-- Step Circle -->
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold transition-all duration-300"
                             :class="currentStep > index + 1 ? 'bg-green-500 text-white' : currentStep === index + 1 ? 'bg-blue-500 text-white scale-110' : 'bg-gray-300 text-gray-600'">
                            <span x-show="currentStep <= index + 1" x-text="index + 1"></span>
                            <svg x-show="currentStep > index + 1" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                        <div class="hidden md:block">
                            <div class="font-bold text-sm" :class="currentStep === index + 1 ? 'text-gray-900' : 'text-gray-500'" x-text="stepInfo.title"></div>
                            <div class="text-xs text-gray-500" x-text="stepInfo.subtitle"></div>
                        </div>
                    </div>
                    <!-- Connector Line -->
                    <div x-show="index < steps.length - 1" class="flex-1 h-1 mx-4 rounded-full transition-all duration-500"
                         :class="currentStep > index + 1 ? 'bg-green-500' : 'bg-gray-300'"></div>
                </div>
            </template>
        </div>
    </div>

    <!-- Main Content Card -->
    <div class="bg-white rounded-lg shadow-lg p-6">
        <!-- Step 1: Input -->
        <div x-show="currentStep === 1" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform translate-x-4" x-transition:enter-end="opacity-100 transform translate-x-0">
            <!-- Dynamic title based on method -->
            <h2 class="text-2xl font-bold mb-4">
                <span x-show="!inputMethod">üì• Choose Input Source</span>
                <span x-show="inputMethod === 'document'">üìÑ Document Input</span>
                <span x-show="inputMethod === 'youtube'">üì∫ YouTube Video Input</span>
                <span x-show="inputMethod === 'yaml'">üìã YAML Configuration</span>
            </h2>

            <!-- Show input type selector ONLY if no method specified -->
            <div x-show="showInputTypeSelector" class="grid md:grid-cols-3 gap-4 mb-6">
                <button @click="inputType = 'url'; inputError = ''" type="button"
                        class="p-6 rounded-lg border-2 transition-all hover:shadow-lg"
                        :class="inputType === 'url' ? 'border-blue-500 bg-blue-50' : 'border-gray-300 hover:border-blue-300'">
                    <div class="text-4xl mb-3">üîó</div>
                    <div class="font-bold text-lg mb-1">URL</div>
                    <div class="text-sm text-gray-600">Website or article</div>
                </button>

                <button @click="inputType = 'file'; inputError = ''" type="button"
                        class="p-6 rounded-lg border-2 transition-all hover:shadow-lg"
                        :class="inputType === 'file' ? 'border-blue-500 bg-blue-50' : 'border-gray-300 hover:border-blue-300'">
                    <div class="text-4xl mb-3">üìÑ</div>
                    <div class="font-bold text-lg mb-1">File</div>
                    <div class="text-sm text-gray-600">Upload document</div>
                </button>

                <button @click="inputType = 'text'; inputError = ''" type="button"
                        class="p-6 rounded-lg border-2 transition-all hover:shadow-lg"
                        :class="inputType === 'text' ? 'border-blue-500 bg-blue-50' : 'border-gray-300 hover:border-blue-300'">
                    <div class="text-4xl mb-3">‚úçÔ∏è</div>
                    <div class="font-bold text-lg mb-1">Text</div>
                    <div class="text-sm text-gray-600">Paste or type</div>
                </button>
            </div>

            <!-- Method-specific help text -->
            <div x-show="inputMethod" class="mb-4 p-4 bg-blue-50 border-l-4 border-blue-500 rounded">
                <p class="text-sm text-blue-900" x-show="inputMethod === 'document'">
                    üìò Upload a document (PDF, DOCX, TXT, MD) or paste text to automatically generate a video.
                </p>
                <p class="text-sm text-blue-900" x-show="inputMethod === 'youtube'">
                    üé• Enter a YouTube URL and we'll extract the transcript to create a summary video.
                </p>
                <p class="text-sm text-blue-900" x-show="inputMethod === 'yaml'">
                    ‚öôÔ∏è Upload a YAML configuration file with your video structure and settings.
                </p>
            </div>

            <!-- Input Fields -->
            <div class="space-y-4">
                <!-- URL Input - WITH REAL-TIME VALIDATION -->
                <div x-show="inputType === 'url'">
                    {% include 'components/validation-feedback.html' %}
                </div>

                <!-- File Upload - NEW MODERN DRAG-DROP COMPONENT -->
                <div x-show="inputType === 'file'"
                     @file-ready.window="handleFileReady($event)">
                    {% include 'components/drag-drop-zone.html' %}
                </div>

                <!-- Text Input -->
                <div x-show="inputType === 'text'">
                    <label for="input-text-content" class="block text-sm font-medium text-gray-700 mb-2">Enter Content</label>
                    <textarea id="input-text-content" x-model="inputData.text" @input="validateInput()"
                              rows="8"
                              placeholder="Paste or type your content here..."
                              aria-label="Content text"
                              class="w-full px-4 py-3 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"
                              :class="inputError ? 'border-red-500' : 'border-gray-300'"></textarea>
                </div>

                <!-- Error Message -->
                <div x-show="inputError" class="bg-red-50 border-2 border-red-200 rounded-lg p-3 flex items-start gap-2">
                    <span class="text-red-500 text-xl">‚ö†Ô∏è</span>
                    <div class="flex-1 text-red-700 text-sm" x-text="inputError"></div>
                </div>
            </div>

            <!-- Navigation (hidden for file upload since drag-drop has its own Continue button) -->
            <div x-show="inputType !== 'file'" class="flex justify-end gap-3 mt-6">
                <button @click="nextStep()" :disabled="!isStepValid(1)"
                        class="px-6 py-3 rounded-lg font-semibold transition-all"
                        :class="isStepValid(1) ? 'bg-blue-500 text-white hover:bg-blue-600 shadow-md hover:shadow-lg' : 'bg-gray-300 text-gray-500 cursor-not-allowed'">
                    Next: Configure ‚Üí
                </button>
            </div>
        </div>

        <!-- Step 2: Configure -->
        <div x-show="currentStep === 2"
             x-data="{
                 activeSection: 'languages',
                 languageTab: 'popular',
                 languageSearch: '',
                 expandedSections: { output: true, appearance: false }
             }"
             @video-id-changed.window="if ($event.detail?.videoId) expandedSections.output = false"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform translate-x-4"
             x-transition:enter-end="opacity-100 transform translate-x-0">

            <div class="flex flex-col lg:flex-row gap-6">
                <!-- Main Configuration Area -->
                <div class="flex-1 space-y-4">
                    <h2 class="text-2xl font-bold mb-2">Configure Video</h2>
                    <p class="text-gray-600 text-sm mb-6">Set up your video settings. Essential fields are marked with <span class="text-red-500">*</span></p>

                    <!-- SECTION 1: Output Settings (Collapsible) -->
                    <div class="config-section bg-white border-2 border-gray-200 rounded-xl overflow-hidden transition-all"
                         :class="expandedSections.output ? 'ring-2 ring-blue-200 border-blue-300' : 'hover:border-gray-300'">
                        <button @click="expandedSections.output = !expandedSections.output"
                                type="button"
                                class="w-full px-5 py-4 flex items-center justify-between bg-gradient-to-r from-gray-50 to-white hover:from-gray-100 hover:to-gray-50 transition-colors">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">üé¨</span>
                                <div class="text-left">
                                    <h3 class="font-semibold text-gray-900">Output Settings</h3>
                                    <p class="text-xs text-gray-500">Video ID, duration, and structure</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="px-2 py-1 bg-red-100 text-red-700 text-xs font-medium rounded">Required</span>
                                <span class="text-xs text-gray-400" x-text="config.videoId ? config.videoId + ' / ' + config.duration + 's' : 'Not configured'"></span>
                                <svg class="w-5 h-5 text-gray-400 transition-transform duration-200"
                                     :class="expandedSections.output ? 'rotate-180' : ''"
                                     fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </button>

                        <div x-show="expandedSections.output"
                             x-collapse
                             x-cloak>
                            <div class="px-5 py-4 border-t border-gray-100 bg-gray-50/50">
                                <div class="grid md:grid-cols-2 gap-6">
                                    <!-- Video ID -->
                                    <div>
                                        <label for="config-video-id" class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                                            Video ID <span class="text-red-500">*</span>
                                            <span class="inline-flex items-center justify-center w-4 h-4 bg-gray-200 rounded-full text-xs text-gray-600 cursor-help"
                                                  title="A unique identifier for your video. Used in filenames and URLs.">?</span>
                                        </label>
                                        <input type="text" id="config-video-id" x-model="config.videoId"
                                               @input="validateConfig(); $dispatch('video-id-changed', {videoId: config.videoId})"
                                               placeholder="my-video"
                                               aria-label="Video identifier"
                                               class="w-full px-4 py-2.5 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                               :class="configErrors.videoId ? 'border-red-500 bg-red-50' : 'border-gray-300'">
                                        <div x-show="configErrors.videoId" class="text-red-600 text-xs mt-1.5 flex items-center gap-1">
                                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                                            <span x-text="configErrors.videoId"></span>
                                        </div>
                                        <div x-show="!configErrors.videoId && config.videoId" class="text-xs text-gray-500 mt-1.5">
                                            Output: <code class="bg-gray-100 px-1.5 py-0.5 rounded font-mono text-gray-700" x-text="config.videoId + '_en.mp4'"></code>
                                        </div>
                                    </div>

                                    <!-- Duration -->
                                    <div>
                                        <label for="config-duration" class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                                            Duration <span class="text-red-500">*</span>
                                            <span x-show="config.videoMode === 'set'" class="text-xs font-normal text-blue-600">(per video)</span>
                                        </label>
                                        <div class="flex items-center gap-3">
                                            <input type="number" id="config-duration" x-model.number="config.duration" @input="validateConfig(); updateCostEstimate()"
                                                   min="30" max="600"
                                                   class="w-28 px-4 py-2.5 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <span class="text-gray-600 text-sm">seconds</span>
                                            <span class="px-2.5 py-1 bg-gray-100 rounded-md text-sm text-gray-600" x-text="Math.floor(config.duration / 60) + 'm ' + (config.duration % 60) + 's'"></span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Video Mode -->
                                <div class="mt-6 pt-5 border-t border-gray-200">
                                    <h4 class="text-sm font-medium text-gray-700 mb-3">Video Structure</h4>
                                    <div class="grid md:grid-cols-2 gap-3">
                                        <button @click="config.videoMode = 'single'; config.videoCount = 1"
                                                type="button"
                                                class="p-4 border-2 rounded-xl text-left transition-all flex items-start gap-3"
                                                :class="config.videoMode === 'single' ? 'bg-blue-50 border-blue-500 ring-1 ring-blue-200' : 'bg-white border-gray-200 hover:border-gray-300'">
                                            <div class="w-10 h-10 rounded-lg flex items-center justify-center text-xl"
                                                 :class="config.videoMode === 'single' ? 'bg-blue-100' : 'bg-gray-100'">üé¨</div>
                                            <div class="flex-1">
                                                <div class="font-semibold text-sm" :class="config.videoMode === 'single' ? 'text-blue-900' : 'text-gray-900'">Single Video</div>
                                                <div class="text-xs text-gray-500 mt-0.5">One complete video from entire content</div>
                                            </div>
                                            <div x-show="config.videoMode === 'single'" class="w-5 h-5 bg-blue-500 rounded-full flex items-center justify-center">
                                                <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                                            </div>
                                        </button>
                                        <button @click="config.videoMode = 'set'; config.videoCount = config.videoCount < 2 ? 4 : config.videoCount"
                                                type="button"
                                                class="p-4 border-2 rounded-xl text-left transition-all flex items-start gap-3"
                                                :class="config.videoMode === 'set' ? 'bg-purple-50 border-purple-500 ring-1 ring-purple-200' : 'bg-white border-gray-200 hover:border-gray-300'">
                                            <div class="w-10 h-10 rounded-lg flex items-center justify-center text-xl"
                                                 :class="config.videoMode === 'set' ? 'bg-purple-100' : 'bg-gray-100'">üìö</div>
                                            <div class="flex-1">
                                                <div class="font-semibold text-sm" :class="config.videoMode === 'set' ? 'text-purple-900' : 'text-gray-900'">Video Series</div>
                                                <div class="text-xs text-gray-500 mt-0.5">Split into multiple videos by section</div>
                                            </div>
                                            <div x-show="config.videoMode === 'set'" class="w-5 h-5 bg-purple-500 rounded-full flex items-center justify-center">
                                                <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                                            </div>
                                        </button>
                                    </div>

                                    <!-- Video count for series -->
                                    <div x-show="config.videoMode === 'set'" x-transition x-cloak class="mt-4 p-4 bg-purple-50 rounded-xl border border-purple-100 space-y-4">
                                        <!-- Video Count -->
                                        <div class="flex items-center gap-4">
                                            <label for="video-count" class="text-sm font-medium text-purple-900">Number of videos:</label>
                                            <input type="number" id="video-count" x-model.number="config.videoCount" min="2" max="10"
                                                   class="w-20 px-3 py-1.5 border-2 border-purple-200 rounded-lg focus:ring-2 focus:ring-purple-500 text-center">
                                            <div class="flex gap-1">
                                                <template x-for="i in Math.min(config.videoCount, 6)" :key="i">
                                                    <div class="w-6 h-5 bg-purple-200 border border-purple-300 rounded text-xs flex items-center justify-center text-purple-700" x-text="i"></div>
                                                </template>
                                                <span x-show="config.videoCount > 6" class="text-xs text-purple-400 self-center ml-1">+<span x-text="config.videoCount - 6"></span></span>
                                            </div>
                                        </div>

                                        <!-- Split Strategy Selector -->
                                        <div>
                                            <label for="split-strategy" class="block text-sm font-medium text-purple-900 mb-2">
                                                Splitting Method
                                            </label>
                                            <select id="split-strategy" x-model="config.splitStrategy"
                                                    class="w-full px-3 py-2 border-2 border-purple-200 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white text-sm">
                                                <option value="auto">ü§ñ Smart Auto-Select (Recommended)</option>
                                                <option value="ai">‚ú® AI-Powered Semantic Splitting</option>
                                                <option value="headers">üìë By Markdown Headers</option>
                                                <option value="paragraph">¬∂ By Paragraphs</option>
                                                <option value="sentence">üìù By Sentences</option>
                                                <option value="length">üìè By Equal Length</option>
                                            </select>
                                            <p class="text-xs text-purple-700 mt-2">
                                                <span x-show="config.splitStrategy === 'auto'">üìö System automatically chooses the best splitting method for your content</span>
                                                <span x-show="config.splitStrategy === 'ai'">‚ú® AI analyzes your content and creates semantic sections with narration (~$0.01)</span>
                                                <span x-show="config.splitStrategy === 'headers'">üìë Splits by markdown ## headers (requires markdown format)</span>
                                                <span x-show="config.splitStrategy === 'paragraph'">¬∂ Splits by paragraph breaks (fast, free)</span>
                                                <span x-show="config.splitStrategy === 'sentence'">üìù Splits evenly by sentences (fast, free)</span>
                                                <span x-show="config.splitStrategy === 'length'">üìè Splits by word count (fast, free)</span>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION 2: Languages & Voices (Primary - Always Visible) -->
                    <div class="config-section config-section--primary bg-white border-2 border-blue-200 rounded-xl overflow-hidden shadow-sm">
                        <div class="px-5 py-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-b border-blue-100">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">üåç</span>
                                    <div>
                                        <h3 class="font-semibold text-gray-900">Languages & Voices</h3>
                                        <p class="text-xs text-gray-600">Select target languages and voice preferences</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="px-2.5 py-1 bg-blue-100 text-blue-700 text-xs font-medium rounded-full"
                                          x-text="(config.languageMode === 'single' ? 1 : config.targetLanguages.length) + ' language' + ((config.languageMode === 'single' ? 1 : config.targetLanguages.length) !== 1 ? 's' : '')"></span>
                                </div>
                            </div>
                        </div>

                        <div class="p-5">
                            <!-- Language Tabs -->
                            <div class="flex border-b border-gray-200 mb-4 -mx-5 px-5">
                                <button @click="languageTab = 'popular'" type="button"
                                        class="px-4 py-2.5 text-sm font-medium border-b-2 transition-colors -mb-px"
                                        :class="languageTab === 'popular' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'">
                                    Popular
                                    <span class="ml-1.5 px-1.5 py-0.5 text-xs rounded-full"
                                          :class="languageTab === 'popular' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600'">8</span>
                                </button>
                                <button @click="languageTab = 'all'" type="button"
                                        class="px-4 py-2.5 text-sm font-medium border-b-2 transition-colors -mb-px"
                                        :class="languageTab === 'all' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'">
                                    All Languages
                                    <span class="ml-1.5 px-1.5 py-0.5 text-xs rounded-full"
                                          :class="languageTab === 'all' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600'">29</span>
                                </button>
                                <button @click="languageTab = 'selected'" type="button"
                                        class="px-4 py-2.5 text-sm font-medium border-b-2 transition-colors -mb-px"
                                        :class="languageTab === 'selected' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'">
                                    Selected
                                    <span class="ml-1.5 px-1.5 py-0.5 text-xs rounded-full"
                                          :class="languageTab === 'selected' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'"
                                          x-text="config.languageMode === 'single' ? 1 : config.targetLanguages.length"></span>
                                </button>
                            </div>

                            <!-- Tab Content: Popular -->
                            <div x-show="languageTab === 'popular'" x-transition:enter="transition ease-out duration-150" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100">
                                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                                    <template x-for="lang in [
                                        {code: 'en', name: 'English', flag: 'üá∫üá∏'},
                                        {code: 'es', name: 'Spanish', flag: 'üá™üá∏'},
                                        {code: 'fr', name: 'French', flag: 'üá´üá∑'},
                                        {code: 'de', name: 'German', flag: 'üá©üá™'},
                                        {code: 'zh', name: 'Chinese', flag: 'üá®üá≥'},
                                        {code: 'ja', name: 'Japanese', flag: 'üáØüáµ'},
                                        {code: 'pt', name: 'Portuguese', flag: 'üáßüá∑'},
                                        {code: 'it', name: 'Italian', flag: 'üáÆüáπ'}
                                    ]" :key="lang.code">
                                        <button @click="toggleLanguageSelection(lang.code)" type="button"
                                                aria-label="Toggle language selection"
                                                :aria-pressed="config.targetLanguages.includes(lang.code)"
                                                class="p-3 rounded-xl border-2 transition-all flex items-center gap-2.5 text-left"
                                                :class="config.targetLanguages.includes(lang.code) ? 'bg-blue-50 border-blue-400 ring-1 ring-blue-200' : 'bg-white border-gray-200 hover:border-gray-300 hover:bg-gray-50'">
                                            <span class="text-xl" x-text="lang.flag" aria-hidden="true"></span>
                                            <span class="text-sm font-medium" :class="config.targetLanguages.includes(lang.code) ? 'text-blue-900' : 'text-gray-700'" x-text="lang.name"></span>
                                            <div x-show="config.targetLanguages.includes(lang.code)" class="ml-auto w-5 h-5 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0" aria-hidden="true">
                                                <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                                            </div>
                                        </button>
                                    </template>
                                </div>

                                <!-- Quick Presets -->
                                <div class="mt-4 pt-4 border-t border-gray-100">
                                    <div class="flex flex-wrap items-center gap-2">
                                        <span class="text-xs text-gray-500 font-medium">Quick presets:</span>
                                        <button @click="applyLanguagePreset('european')" type="button"
                                                class="px-3 py-1.5 text-xs font-medium bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                                            European (6)
                                        </button>
                                        <button @click="applyLanguagePreset('asian')" type="button"
                                                class="px-3 py-1.5 text-xs font-medium bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                                            Asian (5)
                                        </button>
                                        <button @click="applyLanguagePreset('global')" type="button"
                                                class="px-3 py-1.5 text-xs font-medium bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                                            Global Top 8
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Tab Content: All Languages -->
                            <div x-show="languageTab === 'all'" x-transition:enter="transition ease-out duration-150" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100">
                                <!-- Search Box -->
                                <div class="mb-4">
                                    <label for="language-search-input" class="sr-only">Search languages</label>
                                    <input type="search"
                                           id="language-search-input"
                                           x-model="languageSearch"
                                           placeholder="Search languages..."
                                           class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>

                                <!-- Compact Language Grid -->
                                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 max-h-96 overflow-y-auto">
                                    <template x-for="lang in [
                                        {code: 'ar', name: 'Arabic', flag: 'üá∏üá¶'},
                                        {code: 'zh', name: 'Chinese', flag: 'üá®üá≥'},
                                        {code: 'cs', name: 'Czech', flag: 'üá®üáø'},
                                        {code: 'da', name: 'Danish', flag: 'üá©üá∞'},
                                        {code: 'nl', name: 'Dutch', flag: 'üá≥üá±'},
                                        {code: 'en', name: 'English', flag: 'üá∫üá∏'},
                                        {code: 'fi', name: 'Finnish', flag: 'üá´üáÆ'},
                                        {code: 'fr', name: 'French', flag: 'üá´üá∑'},
                                        {code: 'de', name: 'German', flag: 'üá©üá™'},
                                        {code: 'el', name: 'Greek', flag: 'üá¨üá∑'},
                                        {code: 'he', name: 'Hebrew', flag: 'üáÆüá±'},
                                        {code: 'hi', name: 'Hindi', flag: 'üáÆüá≥'},
                                        {code: 'hu', name: 'Hungarian', flag: 'üá≠üá∫'},
                                        {code: 'id', name: 'Indonesian', flag: 'üáÆüá©'},
                                        {code: 'it', name: 'Italian', flag: 'üáÆüáπ'},
                                        {code: 'ja', name: 'Japanese', flag: 'üáØüáµ'},
                                        {code: 'ko', name: 'Korean', flag: 'üá∞üá∑'},
                                        {code: 'no', name: 'Norwegian', flag: 'üá≥üá¥'},
                                        {code: 'pl', name: 'Polish', flag: 'üáµüá±'},
                                        {code: 'pt', name: 'Portuguese', flag: 'üáßüá∑'},
                                        {code: 'ro', name: 'Romanian', flag: 'üá∑üá¥'},
                                        {code: 'ru', name: 'Russian', flag: 'üá∑üá∫'},
                                        {code: 'es', name: 'Spanish', flag: 'üá™üá∏'},
                                        {code: 'sv', name: 'Swedish', flag: 'üá∏üá™'},
                                        {code: 'th', name: 'Thai', flag: 'üáπüá≠'},
                                        {code: 'tr', name: 'Turkish', flag: 'üáπüá∑'},
                                        {code: 'uk', name: 'Ukrainian', flag: 'üá∫üá¶'},
                                        {code: 'vi', name: 'Vietnamese', flag: 'üáªüá≥'},
                                        {code: 'cy', name: 'Welsh', flag: 'üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø'}
                                    ].filter(l => !languageSearch || l.name.toLowerCase().includes(languageSearch.toLowerCase()))" :key="lang.code">
                                        <button @click="toggleLanguageSelection(lang.code)" type="button"
                                                aria-label="Toggle language selection"
                                                :aria-pressed="config.targetLanguages.includes(lang.code)"
                                                class="p-3 rounded-lg border-2 transition-all text-left"
                                                :class="config.targetLanguages.includes(lang.code) ? 'bg-blue-50 border-blue-400 ring-1 ring-blue-200' : 'bg-white border-gray-200 hover:border-gray-300'">
                                            <div class="flex items-center gap-2">
                                                <span class="text-lg" x-text="lang.flag" aria-hidden="true"></span>
                                                <span class="text-sm font-medium truncate" x-text="lang.name"></span>
                                                <div x-show="config.targetLanguages.includes(lang.code)" class="ml-auto w-4 h-4 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0" aria-hidden="true">
                                                    <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                                                </div>
                                            </div>
                                        </button>
                                    </template>
                                </div>
                            </div>

                            <!-- Tab Content: Selected -->
                            <div x-show="languageTab === 'selected'" x-transition:enter="transition ease-out duration-150" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100">
                                <div x-show="config.targetLanguages.length === 0" class="text-center py-8">
                                    <div class="text-4xl mb-3">üåê</div>
                                    <p class="text-gray-500">No languages selected yet</p>
                                    <button @click="languageTab = 'popular'" type="button" class="mt-2 text-blue-600 hover:text-blue-700 text-sm font-medium">
                                        Select from popular languages
                                    </button>
                                </div>
                                <div x-show="config.targetLanguages.length > 0" class="space-y-2">
                                    <template x-for="code in config.targetLanguages" :key="code">
                                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                                            <div class="flex items-center gap-3">
                                                <span class="text-xl" x-text="getLanguageFlag(code)"></span>
                                                <span class="font-medium text-gray-900" x-text="getLanguageName(code)"></span>
                                            </div>
                                            <button @click="toggleLanguageSelection(code)" type="button"
                                                    aria-label="Remove language"
                                                    class="p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors"
                                                    :disabled="config.targetLanguages.length <= 1"
                                                    :class="config.targetLanguages.length <= 1 ? 'opacity-30 cursor-not-allowed' : ''">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <!-- Voice Selection Section (Always Visible Below Tabs) -->
                            <div x-show="config.targetLanguages.length > 0"
                                 x-transition:enter="transition ease-out duration-200"
                                 x-transition:enter-start="opacity-0 transform scale-95"
                                 x-transition:enter-end="opacity-100 transform scale-100"
                                 class="mt-6 pt-6 border-t-2 border-blue-200">

                                <!-- Voice Section Header -->
                                <div class="flex items-center justify-between mb-5">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center text-white text-xl shadow-lg">
                                            üéôÔ∏è
                                        </div>
                                        <div>
                                            <h4 class="text-lg font-bold text-gray-900">Voice Selection</h4>
                                            <p class="text-xs text-gray-600">Select voices for each language - multiple voices enable rotation</p>
                                        </div>
                                    </div>
                                    <div class="px-3 py-1.5 bg-purple-100 text-purple-700 text-xs font-semibold rounded-full">
                                        <span x-text="config.targetLanguages.length"></span> language<span x-show="config.targetLanguages.length !== 1">s</span>
                                    </div>
                                </div>

                                <!-- Voice Selector Component (Multi-Select with Rotation) -->
                                <div class="space-y-4"
                                     x-data="{
                                         voices: {},
                                         selectedVoices: {},
                                         loading: {},

                                         // Multi-select and rotation state
                                         rotationExpanded: {},
                                         rotationStep: {},
                                         rotationIntervals: {},

                                         // Preview state management
                                         previewPlayer: null,
                                         previewState: 'idle',
                                         currentlyPreviewing: null,
                                         previewError: null,
                                         waveformBars: [0,0,0,0,0],

                                         init() {
                                             // Initialize the VoicePreviewPlayer
                                             this.previewPlayer = new VoicePreviewPlayer({
                                                 onStateChange: (state, prev, voice) => {
                                                     this.previewState = state;
                                                     if (state === 'idle' || state === 'error') {
                                                         this.currentlyPreviewing = null;
                                                     }
                                                 },
                                                 onError: (msg, err) => {
                                                     this.previewError = msg;
                                                     setTimeout(() => this.previewError = null, 3000);
                                                 },
                                                 onWaveformData: (data) => {
                                                     const step = Math.floor(data.length / 5);
                                                     this.waveformBars = [
                                                         Math.min(100, data[0] / 2.55),
                                                         Math.min(100, data[step] / 2.55),
                                                         Math.min(100, data[step*2] / 2.55),
                                                         Math.min(100, data[step*3] / 2.55),
                                                         Math.min(100, data[step*4] / 2.55)
                                                     ];
                                                 }
                                             });
                                             config.targetLanguages.forEach(lang => this.loadVoices(lang));
                                         },

                                         async loadVoices(lang) {
                                             if (this.voices[lang]) return;
                                             this.loading[lang] = true;
                                             this.rotationStep[lang] = 0;
                                             try {
                                                 const res = await fetch(`/api/languages/${lang}/voices`);
                                                 const data = await res.json();
                                                 this.voices[lang] = data.voices || [];
                                                 // Auto-select first voice as array for multi-select
                                                 if ((!this.selectedVoices[lang] || this.selectedVoices[lang].length === 0) && this.voices[lang][0]) {
                                                     this.selectedVoices[lang] = [this.voices[lang][0].id];
                                                     config.languageVoices = config.languageVoices || {};
                                                     config.languageVoices[lang] = [this.voices[lang][0].id];
                                                 }
                                             } catch(e) {
                                                 console.error('Voice load error:', e);
                                                 this.voices[lang] = [
                                                     {id: 'male', name: 'Default Male', gender: 'male', gender_symbol: '&#9794;', description: 'Professional, confident'},
                                                     {id: 'female', name: 'Default Female', gender: 'female', gender_symbol: '&#9792;', description: 'Clear, friendly'}
                                                 ];
                                                 this.selectedVoices[lang] = ['male'];
                                             }
                                             this.loading[lang] = false;
                                         },

                                         toggleVoice(lang, voiceId) {
                                             if (!this.selectedVoices[lang]) this.selectedVoices[lang] = [];
                                             const idx = this.selectedVoices[lang].indexOf(voiceId);
                                             if (idx > -1) {
                                                 // Prevent removing last voice
                                                 if (this.selectedVoices[lang].length > 1) {
                                                     this.selectedVoices[lang].splice(idx, 1);
                                                 }
                                             } else {
                                                 // Max 4 voices per language
                                                 if (this.selectedVoices[lang].length < 4) {
                                                     this.selectedVoices[lang].push(voiceId);
                                                 }
                                             }
                                             this.selectedVoices[lang] = [...this.selectedVoices[lang]];
                                             config.languageVoices = config.languageVoices || {};
                                             config.languageVoices[lang] = [...this.selectedVoices[lang]];
                                             this.updateRotationAnimation(lang);
                                         },

                                         isVoiceSelected(lang, voiceId) {
                                             return (this.selectedVoices[lang] || []).includes(voiceId);
                                         },

                                         getSelectedCount(lang) {
                                             return (this.selectedVoices[lang] || []).length;
                                         },

                                         getSelectedVoiceObjects(lang) {
                                             const voiceList = this.voices[lang] || [];
                                             const selected = this.selectedVoices[lang] || [];
                                             return selected.map(id => voiceList.find(v => v.id === id)).filter(Boolean);
                                         },

                                         updateRotationAnimation(lang) {
                                             if (this.rotationIntervals[lang]) clearInterval(this.rotationIntervals[lang]);
                                             const count = this.getSelectedCount(lang);
                                             if (count >= 2) {
                                                 this.rotationStep[lang] = 0;
                                                 this.rotationIntervals[lang] = setInterval(() => {
                                                     this.rotationStep[lang] = (this.rotationStep[lang] + 1) % count;
                                                 }, 1800);
                                             }
                                         },

                                         async playPreview(langCode, voiceId) {
                                             const previewKey = `${langCode}-${voiceId}`;
                                             if (this.currentlyPreviewing === previewKey && this.previewState === 'playing') {
                                                 this.stopPreview();
                                                 return;
                                             }
                                             this.stopPreview();
                                             this.currentlyPreviewing = previewKey;
                                             this.previewState = 'loading';
                                             this.previewError = null;
                                             try {
                                                 const response = await fetch('/api/voice-preview', {
                                                     method: 'POST',
                                                     headers: { 'Content-Type': 'application/json' },
                                                     body: JSON.stringify({ language_code: langCode, voice_id: voiceId })
                                                 });
                                                 if (!response.ok) {
                                                     const errorData = await response.json().catch(() => ({}));
                                                     throw new Error(errorData.error || `HTTP ${response.status}`);
                                                 }
                                                 const audioBlob = await response.blob();
                                                 if (this.currentlyPreviewing !== previewKey) return;
                                                 await this.previewPlayer.play(audioBlob, { langCode, voiceId });
                                             } catch (error) {
                                                 console.error('Preview error:', error);
                                                 this.previewState = 'error';
                                                 this.previewError = error.message || 'Failed to load preview';
                                                 this.currentlyPreviewing = null;
                                                 setTimeout(() => this.previewError = null, 3000);
                                             }
                                         },

                                         stopPreview() {
                                             if (this.previewPlayer) this.previewPlayer.stop();
                                             this.previewState = 'idle';
                                             this.currentlyPreviewing = null;
                                             this.waveformBars = [0,0,0,0,0];
                                         },

                                         isPreviewingVoice(langCode, voiceId) {
                                             return this.currentlyPreviewing === `${langCode}-${voiceId}`;
                                         },

                                         getPreviewButtonState(langCode, voiceId) {
                                             if (!this.isPreviewingVoice(langCode, voiceId)) return 'idle';
                                             return this.previewState;
                                         }
                                     }"
                                     @languages-changed.window="$nextTick(() => config.targetLanguages.forEach(lang => loadVoices(lang)))">

                                    <template x-for="langCode in config.targetLanguages" :key="langCode">
                                        <div class="bg-gradient-to-br from-purple-50 via-pink-50 to-purple-50 rounded-xl border-2 border-purple-200 shadow-sm hover:shadow-md transition-shadow"
                                             x-init="loadVoices(langCode)">

                                            <!-- Language Card Header -->
                                            <div class="p-4 bg-gradient-to-r from-purple-100/80 to-pink-100/80 border-b-2 border-purple-200/50">
                                                <div class="flex items-center justify-between">
                                                    <div class="flex items-center gap-3">
                                                        <span class="text-3xl" x-text="getLanguageFlag(langCode)"></span>
                                                        <div>
                                                            <h5 class="font-bold text-gray-900 text-base" x-text="getLanguageName(langCode)"></h5>
                                                            <p class="text-xs text-purple-700" x-text="!loading[langCode] && voices[langCode] ? voices[langCode].length + ' voices available' : 'Loading...'"></p>
                                                        </div>
                                                    </div>
                                                    <span class="px-3 py-1 bg-purple-600 text-white text-xs font-bold rounded-full shadow flex items-center gap-1.5">
                                                        <span x-text="getSelectedCount(langCode)"></span>/<span>4</span> selected
                                                    </span>
                                                </div>
                                            </div>

                                            <!-- Loading State -->
                                            <div x-show="loading[langCode]" class="p-4">
                                                <div class="flex items-center justify-center gap-3 p-6 bg-white rounded-lg border-2 border-purple-100">
                                                    <svg class="animate-spin w-6 h-6 text-purple-500" fill="none" viewBox="0 0 24 24">
                                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                    </svg>
                                                    <span class="text-sm font-medium text-gray-700">Loading <span x-text="getLanguageName(langCode)"></span> voices...</span>
                                                </div>
                                            </div>

                                            <!-- Voice Options Grid -->
                                            <div x-show="!loading[langCode] && voices[langCode]" class="p-4">
                                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                                                    <template x-for="voice in (voices[langCode] || [])" :key="voice.id">
                                                        <div @click="toggleVoice(langCode, voice.id)"
                                                             class="relative flex flex-col gap-2 p-4 bg-white rounded-xl border-2 transition-all cursor-pointer group hover:border-purple-400 hover:shadow-md"
                                                             :class="isVoiceSelected(langCode, voice.id) ? 'border-purple-600 bg-gradient-to-br from-purple-50 to-pink-50 ring-2 ring-purple-300 shadow-md' : 'border-purple-100'">

                                                            <!-- Checkbox Visual -->
                                                            <div class="absolute top-3 right-3 w-5 h-5 rounded border-2 flex items-center justify-center transition-all"
                                                                 :class="isVoiceSelected(langCode, voice.id) ? 'bg-purple-600 border-purple-600' : 'bg-white border-gray-300'">
                                                                <svg x-show="isVoiceSelected(langCode, voice.id)" class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                                                </svg>
                                                            </div>

                                                            <!-- Voice Info -->
                                                            <div class="flex items-start gap-3 pr-8">
                                                                <div class="w-10 h-10 rounded-lg flex items-center justify-center text-2xl shrink-0"
                                                                     :class="voice.gender === 'male' ? 'bg-blue-100' : 'bg-pink-100'">
                                                                    <span x-text="voice.gender_symbol || (voice.gender === 'male' ? '‚ôÇ' : '‚ôÄ')"></span>
                                                                </div>
                                                                <div class="flex-1 min-w-0">
                                                                    <div class="font-bold text-sm text-gray-900 truncate mb-0.5" x-text="voice.name || voice.id"></div>
                                                                    <div class="text-xs text-gray-600 line-clamp-2" x-text="voice.description || 'Natural voice'"></div>
                                                                </div>
                                                            </div>

                                                            <!-- Preview Button -->
                                                            <button @click.stop.prevent="playPreview(langCode, voice.id)"
                                                                    type="button"
                                                                    aria-label="Preview voice sample"
                                                                    class="mt-2 w-full px-3 py-2.5 text-white text-xs font-semibold rounded-lg transition-all flex items-center justify-center gap-2 shadow-sm hover:shadow"
                                                                    :class="{
                                                                        'bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 group-hover:scale-[1.02]': getPreviewButtonState(langCode, voice.id) === 'idle',
                                                                        'bg-gradient-to-r from-amber-500 to-orange-500 cursor-wait': getPreviewButtonState(langCode, voice.id) === 'loading',
                                                                        'bg-gradient-to-r from-green-500 to-emerald-500 hover:from-red-500 hover:to-rose-500': getPreviewButtonState(langCode, voice.id) === 'playing',
                                                                        'bg-gradient-to-r from-red-500 to-rose-500': getPreviewButtonState(langCode, voice.id) === 'error'
                                                                    }"
                                                                    :disabled="getPreviewButtonState(langCode, voice.id) === 'loading'"
                                                                    :title="getPreviewButtonState(langCode, voice.id) === 'playing' ? 'Click to stop' : 'Preview voice'">

                                                                <!-- Idle State -->
                                                                <template x-if="getPreviewButtonState(langCode, voice.id) === 'idle'">
                                                                    <span class="flex items-center gap-2">
                                                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                                            <path d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.617.814L4.447 14H2a1 1 0 01-1-1V7a1 1 0 011-1h2.447l3.936-2.814A1 1 0 019.383 3.076zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.415z"/>
                                                                        </svg>
                                                                        <span>Preview Voice</span>
                                                                    </span>
                                                                </template>

                                                                <!-- Loading State -->
                                                                <template x-if="getPreviewButtonState(langCode, voice.id) === 'loading'">
                                                                    <span class="flex items-center gap-2">
                                                                        <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                                                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                                        </svg>
                                                                        <span>Loading...</span>
                                                                    </span>
                                                                </template>

                                                                <!-- Playing State with Waveform -->
                                                                <template x-if="getPreviewButtonState(langCode, voice.id) === 'playing'">
                                                                    <span class="flex items-center gap-2">
                                                                        <!-- Waveform Visualization -->
                                                                        <span class="flex items-end gap-0.5 h-4">
                                                                            <template x-for="(bar, i) in waveformBars" :key="i">
                                                                                <span class="w-1 bg-white rounded-full transition-all duration-75"
                                                                                      :style="`height: ${Math.max(15, bar)}%`"></span>
                                                                            </template>
                                                                        </span>
                                                                        <span>Playing... (click to stop)</span>
                                                                    </span>
                                                                </template>

                                                                <!-- Error State -->
                                                                <template x-if="getPreviewButtonState(langCode, voice.id) === 'error'">
                                                                    <span class="flex items-center gap-2">
                                                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                                                        </svg>
                                                                        <span>Error - Try Again</span>
                                                                    </span>
                                                                </template>
                                                            </button>

                                                            <!-- Error Toast (shows below button) -->
                                                            <div x-show="previewError && isPreviewingVoice(langCode, voice.id)"
                                                                 x-transition:enter="transition ease-out duration-200"
                                                                 x-transition:enter-start="opacity-0 transform -translate-y-1"
                                                                 x-transition:enter-end="opacity-100 transform translate-y-0"
                                                                 x-transition:leave="transition ease-in duration-150"
                                                                 x-transition:leave-start="opacity-100"
                                                                 x-transition:leave-end="opacity-0"
                                                                 class="mt-1 px-2 py-1 bg-red-100 border border-red-300 text-red-700 text-xs rounded-md">
                                                                <span x-text="previewError"></span>
                                                            </div>

                                                            <!-- Selection Order Badge -->
                                                            <div x-show="isVoiceSelected(langCode, voice.id)"
                                                                 class="absolute -top-2 -right-2 w-7 h-7 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center shadow-lg text-white text-xs font-bold">
                                                                <span x-text="(selectedVoices[langCode] || []).indexOf(voice.id) + 1"></span>
                                                            </div>
                                                        </div>
                                                    </template>
                                                </div>

                                                <!-- No Voices Fallback -->
                                                <div x-show="!voices[langCode] || voices[langCode].length === 0" class="text-center py-8">
                                                    <div class="text-4xl mb-2">üé§</div>
                                                    <p class="text-gray-500 text-sm">No voices available for this language</p>
                                                </div>

                                                <!-- Voice Rotation Visualization (shows when 2+ voices selected) -->
                                                <div x-show="getSelectedCount(langCode) >= 2"
                                                     x-transition:enter="transition ease-out duration-300"
                                                     x-transition:enter-start="opacity-0 transform translate-y-2"
                                                     x-transition:enter-end="opacity-100 transform translate-y-0"
                                                     class="mt-4 rounded-xl overflow-hidden border-2 border-purple-300 shadow-md"
                                                     x-init="$watch('selectedVoices[langCode]', () => updateRotationAnimation(langCode))">

                                                    <!-- Header with Gradient -->
                                                    <div class="bg-gradient-to-r from-purple-600 via-pink-500 to-purple-600 px-4 py-3">
                                                        <div class="flex items-center justify-between">
                                                            <div class="flex items-center gap-2 text-white">
                                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                                                </svg>
                                                                <span class="font-bold text-sm">Voice Rotation Active</span>
                                                            </div>
                                                            <button @click="rotationExpanded[langCode] = !rotationExpanded[langCode]"
                                                                    type="button"
                                                                    aria-label="Toggle voice rotation details"
                                                                    class="text-white/80 hover:text-white text-xs flex items-center gap-1 transition-colors">
                                                                <span x-text="rotationExpanded[langCode] ? 'Hide Details' : 'Learn More'"></span>
                                                                <svg class="w-4 h-4 transition-transform duration-200" :class="rotationExpanded[langCode] ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                                </svg>
                                                            </button>
                                                        </div>
                                                    </div>

                                                    <!-- Rotation Preview Animation -->
                                                    <div class="bg-gradient-to-br from-purple-50 via-pink-50 to-purple-50 p-4">
                                                        <!-- Voice Rotation Chain -->
                                                        <div class="flex items-center justify-center gap-1 flex-wrap mb-3">
                                                            <template x-for="(voice, idx) in getSelectedVoiceObjects(langCode)" :key="voice.id">
                                                                <div class="flex items-center">
                                                                    <!-- Voice Badge -->
                                                                    <div class="px-3 py-1.5 rounded-full text-xs font-semibold flex items-center gap-1.5 transition-all duration-500 shadow-sm"
                                                                         :class="rotationStep[langCode] === idx ? 'bg-gradient-to-r from-purple-600 to-pink-500 text-white scale-110 shadow-lg ring-2 ring-purple-300' : 'bg-white text-gray-700 border border-purple-200'">
                                                                        <span class="w-4 h-4 rounded-full flex items-center justify-center text-xs"
                                                                              :class="voice.gender === 'male' ? 'bg-blue-100 text-blue-600' : 'bg-pink-100 text-pink-600'"
                                                                              x-text="voice.gender === 'male' ? '&#9794;' : '&#9792;'"></span>
                                                                        <span x-text="voice.name || voice.id" class="max-w-20 truncate"></span>
                                                                    </div>
                                                                    <!-- Arrow (not after last item) -->
                                                                    <svg x-show="idx < getSelectedVoiceObjects(langCode).length - 1"
                                                                         class="w-5 h-5 text-purple-400 mx-1 flex-shrink-0"
                                                                         :class="{'animate-pulse text-purple-600': rotationStep[langCode] === idx}"
                                                                         fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                                                                    </svg>
                                                                </div>
                                                            </template>
                                                            <!-- Circular arrow back to first -->
                                                            <svg x-show="getSelectedCount(langCode) >= 2"
                                                                 class="w-5 h-5 text-purple-400 mx-1"
                                                                 :class="{'animate-pulse text-purple-600': rotationStep[langCode] === getSelectedCount(langCode) - 1}"
                                                                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9"></path>
                                                            </svg>
                                                        </div>

                                                        <!-- Scene Preview Example -->
                                                        <div class="bg-white/80 rounded-lg p-3 border border-purple-100">
                                                            <div class="text-xs text-gray-500 mb-2 font-medium text-center">Scene Narration Preview</div>
                                                            <div class="flex items-center justify-center gap-2 flex-wrap">
                                                                <template x-for="(voice, idx) in getSelectedVoiceObjects(langCode).slice(0, 4)" :key="'scene-' + voice.id">
                                                                    <div class="flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg text-xs transition-all duration-500"
                                                                         :class="rotationStep[langCode] === idx ? 'bg-purple-100 border-2 border-purple-400 shadow' : 'bg-gray-50 border border-gray-200'">
                                                                        <span class="font-bold text-purple-700" x-text="'Scene ' + (idx + 1) + ':'"></span>
                                                                        <span class="text-gray-600" x-text="voice.name || voice.id"></span>
                                                                        <span class="text-gray-400" x-text="voice.gender === 'male' ? '(male)' : '(female)'"></span>
                                                                    </div>
                                                                </template>
                                                            </div>
                                                            <div class="text-center mt-2 text-xs text-gray-400">
                                                                <span x-show="getSelectedCount(langCode) > 4">... and more scenes continue the rotation</span>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Expandable Details -->
                                                    <div x-show="rotationExpanded[langCode]"
                                                         x-collapse
                                                         class="border-t border-purple-200 bg-white">
                                                        <div class="p-4 space-y-3">
                                                            <div class="flex gap-3">
                                                                <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center flex-shrink-0">
                                                                    <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                                    </svg>
                                                                </div>
                                                                <div class="text-xs text-gray-600 leading-relaxed">
                                                                    <p class="font-semibold text-gray-800 mb-1">How Voice Rotation Works</p>
                                                                    <p>When you select multiple voices, they automatically rotate for each scene in your video. This creates a more dynamic and engaging narration experience with varied vocal perspectives.</p>
                                                                </div>
                                                            </div>
                                                            <div class="flex gap-3">
                                                                <div class="w-8 h-8 rounded-full bg-pink-100 flex items-center justify-center flex-shrink-0">
                                                                    <svg class="w-4 h-4 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                                                    </svg>
                                                                </div>
                                                                <div class="text-xs text-gray-600 leading-relaxed">
                                                                    <p class="font-semibold text-gray-800 mb-1">Pro Tip</p>
                                                                    <p>Mixing male and female voices creates conversational dynamics. The order you select voices determines the rotation sequence shown in the badges above each voice card.</p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>

                                <!-- Voice Selection Summary -->
                                <div class="mt-4 p-4 bg-gradient-to-r from-purple-50 via-pink-50 to-purple-50 rounded-xl border-2 border-purple-200">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg flex items-center justify-center text-white shadow-md">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        </div>
                                        <div class="flex-1">
                                            <div class="font-semibold text-sm text-gray-900">Voice Configuration Ready</div>
                                            <div class="text-xs text-gray-600">
                                                <span>Select multiple voices per language for dynamic rotation, or use a single voice for consistent narration.</span>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-1 px-2 py-1 bg-purple-100 rounded-lg">
                                            <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            <span class="text-xs text-purple-700 font-medium">Max 4 per language</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION 3: Appearance & Style (Collapsible) -->
                    <div class="config-section bg-white border-2 border-gray-200 rounded-xl overflow-hidden transition-all"
                         :class="expandedSections.appearance ? 'ring-2 ring-blue-200 border-blue-300' : 'hover:border-gray-300'">
                        <button @click="expandedSections.appearance = !expandedSections.appearance"
                                type="button"
                                class="w-full px-5 py-4 flex items-center justify-between bg-gradient-to-r from-gray-50 to-white hover:from-gray-100 hover:to-gray-50 transition-colors">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">üé®</span>
                                <div class="text-left">
                                    <h3 class="font-semibold text-gray-900">Appearance & Style</h3>
                                    <p class="text-xs text-gray-500">Color theme and visual preferences</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs font-medium rounded">Optional</span>
                                <div class="w-6 h-6 rounded-full border-2 border-gray-200"
                                     :class="{
                                         'bg-blue-500': config.color === 'blue',
                                         'bg-green-500': config.color === 'green',
                                         'bg-purple-500': config.color === 'purple',
                                         'bg-cyan-500': config.color === 'cyan'
                                     }"></div>
                                <svg class="w-5 h-5 text-gray-400 transition-transform duration-200"
                                     :class="expandedSections.appearance ? 'rotate-180' : ''"
                                     fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </button>

                        <div x-show="expandedSections.appearance"
                             x-collapse
                             x-cloak>
                            <div class="px-5 py-4 border-t border-gray-100 bg-gray-50/50">
                                <!-- Color Theme -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-3">Color Theme</label>
                                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                                        <template x-for="theme in [
                                            {id: 'blue', name: 'Corporate', class: 'bg-blue-500'},
                                            {id: 'green', name: 'Growth', class: 'bg-green-500'},
                                            {id: 'purple', name: 'Creative', class: 'bg-purple-500'},
                                            {id: 'cyan', name: 'Technical', class: 'bg-cyan-500'}
                                        ]" :key="theme.id">
                                            <button @click="config.color = theme.id" type="button"
                                                    aria-label="Select color theme"
                                                    :aria-pressed="config.color === theme.id"
                                                    class="p-3 rounded-xl border-2 transition-all flex flex-col items-center gap-2"
                                                    :class="config.color === theme.id ? 'border-gray-900 ring-2 ring-gray-200 bg-gray-50' : 'border-gray-200 hover:border-gray-300'">
                                                <div class="w-10 h-10 rounded-lg shadow-inner" :class="theme.class" aria-hidden="true"></div>
                                                <span class="text-xs font-medium" :class="config.color === theme.id ? 'text-gray-900' : 'text-gray-600'" x-text="theme.name"></span>
                                            </button>
                                        </template>
                                    </div>
                                </div>

                                <!-- AI Narration Info -->
                                <div class="mt-5 p-4 bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl border border-purple-100">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center text-xl">ü§ñ</div>
                                        <div class="flex-1">
                                            <div class="font-semibold text-sm text-gray-900">AI Narration Enhancement</div>
                                            <div class="text-xs text-gray-600">Powered by Claude Sonnet 4.5</div>
                                        </div>
                                        <span class="px-2.5 py-1 bg-green-100 text-green-700 text-xs font-semibold rounded-full">ACTIVE</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Presets (Compact) -->
                    <div class="flex flex-wrap items-center gap-3 p-4 bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl border border-amber-200">
                        <span class="text-sm font-medium text-amber-900 flex items-center gap-2">
                            <span>‚ö°</span> Quick Presets:
                        </span>
                        <button @click="applyPreset('corporate')" type="button"
                                class="px-3 py-1.5 text-sm font-medium rounded-lg transition-all"
                                :class="selectedPreset === 'corporate' ? 'bg-blue-500 text-white' : 'bg-white text-gray-700 hover:bg-amber-100 border border-amber-200'">
                            üíº Corporate
                        </button>
                        <button @click="applyPreset('creative')" type="button"
                                class="px-3 py-1.5 text-sm font-medium rounded-lg transition-all"
                                :class="selectedPreset === 'creative' ? 'bg-blue-500 text-white' : 'bg-white text-gray-700 hover:bg-amber-100 border border-amber-200'">
                            üé® Creative
                        </button>
                        <button @click="applyPreset('educational')" type="button"
                                class="px-3 py-1.5 text-sm font-medium rounded-lg transition-all"
                                :class="selectedPreset === 'educational' ? 'bg-blue-500 text-white' : 'bg-white text-gray-700 hover:bg-amber-100 border border-amber-200'">
                            üéì Educational
                        </button>
                    </div>

                    <!-- Navigation -->
                    <div class="flex justify-between gap-3 pt-4">
                        <button @click="previousStep()"
                                class="px-6 py-3 rounded-lg font-semibold bg-gray-100 text-gray-700 hover:bg-gray-200 transition-all border border-gray-200">
                            ‚Üê Back
                        </button>
                        <button @click="nextStep()" :disabled="!isStepValid(2)"
                                class="px-6 py-3 rounded-lg font-semibold transition-all shadow-md hover:shadow-lg"
                                :class="isStepValid(2) ? 'bg-blue-500 text-white hover:bg-blue-600' : 'bg-gray-300 text-gray-500 cursor-not-allowed'">
                            Next: Review ‚Üí
                        </button>
                    </div>
                </div>

                <!-- Sticky Summary Sidebar -->
                <div class="lg:w-80 lg:flex-shrink-0">
                    <div class="lg:sticky lg:top-6 space-y-4">
                        <!-- Generation Summary Card -->
                        <div class="bg-gradient-to-br from-indigo-600 to-purple-700 text-white rounded-2xl p-5 shadow-xl">
                            <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                                <span>üìä</span> Generation Summary
                            </h3>

                            <div class="space-y-4">
                                <!-- Videos -->
                                <div class="flex items-center justify-between">
                                    <span class="text-indigo-200 text-sm">Videos</span>
                                    <span class="text-2xl font-bold" x-text="config.videoMode === 'single' ? '1' : config.videoCount"></span>
                                </div>

                                <!-- Languages -->
                                <div class="flex items-center justify-between">
                                    <span class="text-indigo-200 text-sm">Languages</span>
                                    <span class="text-2xl font-bold" x-text="config.languageMode === 'single' ? '1' : config.targetLanguages.length"></span>
                                </div>

                                <div class="border-t border-indigo-400/30 pt-4">
                                    <!-- Total Output -->
                                    <div class="flex items-center justify-between">
                                        <span class="text-indigo-200 text-sm">Total Files</span>
                                        <span class="text-3xl font-bold text-white" x-text="getTotalVideoCount()"></span>
                                    </div>
                                    <div class="text-xs text-indigo-300 mt-1" x-text="getVideoCountExplanation()"></div>
                                </div>

                                <!-- Duration -->
                                <div class="bg-indigo-500/30 rounded-xl p-3 mt-3">
                                    <div class="flex items-center justify-between">
                                        <span class="text-indigo-200 text-sm">Total Content</span>
                                        <span class="text-xl font-bold" x-text="formatTotalDuration()"></span>
                                    </div>
                                    <div class="text-xs text-indigo-300 mt-0.5" x-text="'~' + config.duration + 's per video'"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Output Preview Card -->
                        <div class="bg-white rounded-xl border-2 border-gray-200 p-4 shadow-sm">
                            <h4 class="font-semibold text-gray-900 text-sm mb-3 flex items-center gap-2">
                                <span>üìÅ</span> Output Files
                            </h4>
                            <div class="space-y-1 text-xs max-h-48 overflow-y-auto">
                                <template x-for="lang in (config.languageMode === 'single' ? ['en'] : config.targetLanguages.slice(0, 2))" :key="lang">
                                    <div>
                                        <!-- Single Video -->
                                        <div x-show="config.videoMode === 'single'" class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg">
                                            <span x-text="getLanguageFlag(lang)"></span>
                                            <code class="flex-1 text-gray-600 font-mono truncate" x-text="(config.videoId || 'video') + '_' + lang + '.mp4'"></code>
                                        </div>
                                        <!-- Video Set -->
                                        <div x-show="config.videoMode === 'set'" class="space-y-0.5">
                                            <div class="flex items-center gap-2 px-2 py-1">
                                                <span x-text="getLanguageFlag(lang)"></span>
                                                <span class="font-medium text-gray-700" x-text="getLanguageName(lang)"></span>
                                            </div>
                                            <template x-for="i in Math.min(config.videoCount, 3)" :key="i">
                                                <div class="flex items-center gap-2 p-1.5 pl-8 bg-gray-50 rounded">
                                                    <code class="flex-1 text-gray-600 font-mono text-xs" x-text="(config.videoId || 'video') + '_' + lang + '_' + String(i).padStart(2, '0') + '.mp4'"></code>
                                                </div>
                                            </template>
                                            <div x-show="config.videoCount > 3" class="pl-8 text-gray-400 text-xs">
                                                ... +<span x-text="config.videoCount - 3"></span> more
                                            </div>
                                        </div>
                                    </div>
                                </template>
                                <div x-show="config.targetLanguages.length > 2 && config.languageMode !== 'single'"
                                     class="text-center text-gray-400 py-1 border-t mt-1 pt-1">
                                    +<span x-text="(config.targetLanguages.length - 2) * (config.videoMode === 'single' ? 1 : config.videoCount)"></span> more files...
                                </div>
                            </div>
                        </div>

                        <!-- Validation Status -->
                        <div class="bg-white rounded-xl border-2 p-4 transition-colors"
                             :class="isStepValid(2) ? 'border-green-200 bg-green-50' : 'border-amber-200 bg-amber-50'">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center"
                                     :class="isStepValid(2) ? 'bg-green-100 text-green-600' : 'bg-amber-100 text-amber-600'">
                                    <svg x-show="isStepValid(2)" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    <svg x-show="!isStepValid(2)" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <div>
                                    <div class="font-medium text-sm" :class="isStepValid(2) ? 'text-green-900' : 'text-amber-900'"
                                         x-text="isStepValid(2) ? 'Ready to continue' : 'Missing required fields'"></div>
                                    <div class="text-xs" :class="isStepValid(2) ? 'text-green-700' : 'text-amber-700'"
                                         x-text="isStepValid(2) ? 'All settings configured' : 'Please fill in Video ID'"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Review -->
        <div x-show="currentStep === 3" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform translate-x-4" x-transition:enter-end="opacity-100 transform translate-x-0">
            <h2 class="text-2xl font-bold mb-4">Review Configuration</h2>

            <!-- FINAL OUTPUT SUMMARY - Clear "What You'll Get" Box -->
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl p-6 mb-6 shadow-lg">
                <h3 class="font-bold text-xl mb-4 flex items-center gap-2">
                    <span>üì¶</span>
                    What You'll Get
                </h3>
                <div class="grid md:grid-cols-3 gap-6">
                    <!-- Total Files -->
                    <div class="text-center">
                        <div class="text-5xl font-bold mb-2" x-text="getTotalVideoCount()"></div>
                        <div class="text-indigo-200 text-sm">Video File(s)</div>
                        <div class="text-xs text-indigo-300 mt-1" x-text="getVideoCountExplanation()"></div>
                    </div>
                    <!-- Total Duration -->
                    <div class="text-center">
                        <div class="text-5xl font-bold mb-2" x-text="formatTotalDuration()"></div>
                        <div class="text-indigo-200 text-sm">Total Content</div>
                        <div class="text-xs text-indigo-300 mt-1" x-text="'~' + config.duration + 's per video'"></div>
                    </div>
                    <!-- Output Format -->
                    <div class="text-center">
                        <div class="text-5xl font-bold mb-2">MP4</div>
                        <div class="text-indigo-200 text-sm">Output Format</div>
                        <div class="text-xs text-indigo-300 mt-1">1920x1080 HD</div>
                    </div>
                </div>

                <!-- Detailed File List (when multiple) -->
                <div x-show="getTotalVideoCount() > 1"
                     x-transition
                     class="mt-6 pt-4 border-t border-indigo-400">
                    <div class="text-sm font-semibold mb-3 text-indigo-200">Output Files:</div>
                    <div class="grid gap-2 text-sm">
                        <template x-for="lang in (config.languageMode === 'single' ? ['en'] : config.targetLanguages)" :key="lang">
                            <div class="flex items-center gap-2 bg-indigo-500/30 rounded-lg px-3 py-2">
                                <span x-text="getLanguageFlag(lang)"></span>
                                <span class="font-medium" x-text="getLanguageName(lang)"></span>
                                <span class="text-indigo-300">:</span>
                                <template x-if="config.videoMode === 'single'">
                                    <code class="bg-indigo-700/50 px-2 py-0.5 rounded text-xs" x-text="(config.videoId || 'video') + '_' + lang + '.mp4'"></code>
                                </template>
                                <template x-if="config.videoMode === 'set'">
                                    <span class="text-indigo-200 text-xs">
                                        <code class="bg-indigo-700/50 px-2 py-0.5 rounded" x-text="(config.videoId || 'video') + '_' + lang + '_01.mp4'"></code>
                                        <span class="mx-1">to</span>
                                        <code class="bg-indigo-700/50 px-2 py-0.5 rounded" x-text="(config.videoId || 'video') + '_' + lang + '_' + String(config.videoCount).padStart(2, '0') + '.mp4'"></code>
                                    </span>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- NEW: Preview Panel Component -->
            <div class="mb-6">
                {% include 'components/preview-panel.html' %}
            </div>

            <!-- Cost Estimate -->
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-xl p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-bold text-gray-900 flex items-center gap-2">
                        <span class="text-xl">üí∞</span>
                        Estimated Cost
                    </h3>
                    <div class="text-3xl font-bold text-green-700" x-text="'$' + costEstimate.total.toFixed(4)"></div>
                </div>
                <div class="space-y-2">
                    <template x-for="item in costEstimate.breakdown" :key="item.item">
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-700" x-text="item.details"></span>
                            <span class="font-semibold text-gray-900" x-text="'$' + item.cost.toFixed(4)"></span>
                        </div>
                    </template>
                </div>
                <div class="mt-4 pt-4 border-t border-green-300 text-xs text-gray-600">
                    <div>TTS is always free (Edge-TTS)</div>
                    <div>AI narration enhancement always enabled for superior quality</div>
                </div>
            </div>

            <!-- Configuration Summary -->
            <div class="grid md:grid-cols-2 gap-4 mb-6">
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="text-sm font-semibold text-gray-700 mb-2">Input Source</div>
                    <div class="text-sm text-gray-900" x-text="inputType === 'url' ? 'URL: ' + inputData.url : inputType === 'file' ? 'File: ' + inputData.fileName : 'Custom Text'"></div>
                </div>

                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="text-sm font-semibold text-gray-700 mb-2">Video ID</div>
                    <div class="text-sm text-gray-900" x-text="config.videoId"></div>
                </div>

                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="text-sm font-semibold text-gray-700 mb-2">Duration per Video</div>
                    <div class="text-sm text-gray-900">
                        <span x-text="config.duration + ' seconds'"></span>
                        <span class="text-gray-500" x-text="'(' + Math.floor(config.duration / 60) + 'm ' + (config.duration % 60) + 's)'"></span>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="text-sm font-semibold text-gray-700 mb-2">Languages</div>
                    <div class="text-sm text-gray-900" x-text="config.languageMode === 'single' ? 'Single Language (English)' : config.targetLanguages.length + ' languages: ' + config.targetLanguages.map(c => getLanguageName(c)).join(', ')"></div>
                </div>

                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="text-sm font-semibold text-gray-700 mb-2">Voice</div>
                    <div class="text-sm text-gray-900" x-text="config.primaryVoice.split('-')[2]"></div>
                </div>

                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="text-sm font-semibold text-gray-700 mb-2">Video Mode</div>
                    <div class="text-sm text-gray-900" x-text="config.videoMode === 'single' ? 'Single Video' : 'Video Set (' + config.videoCount + ' videos)'"></div>
                </div>

                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="text-sm font-semibold text-gray-700 mb-2">AI Narration</div>
                    <div class="text-sm text-gray-900 flex items-center gap-2">
                        <span class="px-2 py-0.5 bg-green-100 text-green-800 text-xs font-semibold rounded">ENABLED</span>
                        <span>Claude Sonnet 4.5</span>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="flex justify-between gap-3 mt-6">
                <button @click="previousStep()"
                        class="px-6 py-3 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300 transition-all">
                    ‚Üê Back
                </button>
                <button @click="nextStep()"
                        class="px-6 py-3 rounded-lg font-semibold bg-blue-500 text-white hover:bg-blue-600 shadow-md hover:shadow-lg transition-all">
                    Next: Generate ‚Üí
                </button>
            </div>
        </div>

        <!-- Step 4: Generate -->
        <div x-show="currentStep === 4" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform translate-x-4" x-transition:enter-end="opacity-100 transform translate-x-0">
            <h2 class="text-2xl font-bold mb-4">üöÄ Generate Video</h2>

            <!-- NEW: Progress Indicator Component -->
            <div x-data="progressIndicator()">
                {% include 'components/progress-indicator.html' %}
            </div>

            <!-- Generation Status (Legacy - kept for fallback) -->
            <div x-show="!generationComplete && !$store.appState.progress.isProcessing" class="space-y-4">
                <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-6 text-center">
                    <div class="text-6xl mb-4 animate-bounce">üé¨</div>
                    <div class="text-xl font-bold text-gray-900 mb-2">Generating Your Video...</div>
                    <div class="text-gray-600 mb-4">This may take a few minutes</div>

                    <!-- Progress Bar -->
                    <div class="w-full bg-gray-200 rounded-full h-4 mb-4">
                        <div class="bg-blue-500 h-4 rounded-full transition-all duration-500" :style="'width: ' + generationProgress + '%'"></div>
                    </div>

                    <div class="text-sm text-gray-600" x-text="generationStatus"></div>
                </div>
            </div>

            <!-- Success Message -->
            <div x-show="generationComplete" class="space-y-4">
                <div class="bg-green-50 border-2 border-green-200 rounded-xl p-6 text-center">
                    <div class="text-6xl mb-4">‚úÖ</div>
                    <div class="text-2xl font-bold text-green-900 mb-2">Video Generated Successfully!</div>
                    <div class="text-gray-600 mb-4">Your video is ready to view</div>

                    <div class="flex justify-center gap-4">
                        <a :href="'/progress#' + generatedJobId"
                           class="px-6 py-3 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 transition-all">
                            View Video
                        </a>
                        <button @click="reset()"
                                class="px-6 py-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition-all">
                            Create Another
                        </button>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <div x-show="!generationStarted" class="flex justify-between gap-3 mt-6">
                <button @click="previousStep()"
                        class="px-6 py-3 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300 transition-all">
                    ‚Üê Back
                </button>
                <button @click="startGeneration()"
                        class="px-6 py-3 rounded-lg font-semibold bg-green-500 text-white hover:bg-green-600 shadow-md hover:shadow-lg transition-all">
                    üöÄ Start Generation
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function unifiedCreator() {
    return {
        // Step management
        currentStep: 1,
        steps: [
            { title: 'Input', subtitle: 'Choose source' },
            { title: 'Configure', subtitle: 'Video settings' },
            { title: 'Review', subtitle: 'Check details' },
            { title: 'Generate', subtitle: 'Create video' }
        ],

        // Input data
        inputType: 'url',
        inputMethod: null, // Tracks which home page card was clicked (document/youtube/yaml)
        showInputTypeSelector: true, // Hide selector when coming from home page
        inputData: {
            url: '',
            file: null,
            fileName: '',
            fileContent: '', // Actual file content (read via FileReader)
            text: ''
        },
        inputError: '',
        isReadingFile: false, // Track async file reading state

        // Configuration
        config: {
            videoId: '',
            duration: 120,
            videoMode: 'single', // 'single' or 'set'
            videoCount: 1, // Number of videos in set
            splitStrategy: 'auto', // ‚ú® NEW: Splitting strategy (auto, ai, headers, paragraph, sentence, length)
            enableAISplitting: true, // ‚ú® NEW: Enable AI-powered splitting
            languageMode: 'single',
            targetLanguages: ['en'],
            primaryVoice: 'en-US-JennyNeural',
            color: 'blue',
            useAI: true, // ALWAYS TRUE - AI narration always enabled
            quality: '1080p', // Video quality
            outputFormat: 'mp4', // Output format
            aspectRatio: '16:9', // Aspect ratio
            includeSubtitles: false // Subtitles toggle
        },

        // Voice selection (simplified - one voice per language)
        voicesByLanguage: {}, // Fetched voices per language {en: [{id, name, ...}]}
        selectedVoicePerLanguage: {}, // Selected voice per language {en: 'male'}
        configErrors: {},
        selectedPreset: null,

        // Available options
        availableLanguages: [
            { code: 'en', name: 'English' },
            { code: 'es', name: 'Spanish' },
            { code: 'fr', name: 'French' },
            { code: 'de', name: 'German' }
        ],

        // Cost estimation
        costEstimate: {
            total: 0,
            breakdown: []
        },

        // Generation
        generationStarted: false,
        generationProgress: 0,
        generationStatus: 'Initializing...',
        generationComplete: false,
        generatedJobId: null,

        // Security - AbortController for cleanup (FIX C2: Memory leak prevention)
        pollAbortController: null,
        retryCount: 0,
        maxRetries: 3,

        init() {
            // Read method from URL query parameter
            const urlParams = new URLSearchParams(window.location.search);
            const method = urlParams.get('method');

            // Map home page methods to input types and customize UI
            if (method === 'document') {
                this.inputType = 'file'; // Document upload
                this.inputMethod = 'document';
                this.showInputTypeSelector = false; // Hide selector
            } else if (method === 'youtube') {
                this.inputType = 'url'; // YouTube URL
                this.inputMethod = 'youtube';
                this.showInputTypeSelector = false; // Hide selector
            } else if (method === 'wizard') {
                // Redirect to builder for full scene-by-scene control
                window.location.href = '/builder';
                return;
            } else if (method === 'yaml') {
                this.inputType = 'file'; // YAML file upload
                this.inputMethod = 'yaml';
                this.showInputTypeSelector = false; // Hide selector
            }

            // Initialize cost estimator
            if (window.CostEstimator) {
                this.costEstimator = new window.CostEstimator();
            }

            // Initialize validator
            if (window.FormValidator) {
                this.validator = new window.FormValidator();
            }

            // Load presets
            if (window.PRESET_PACKAGES) {
                this.presets = window.PRESET_PACKAGES;
            }
        },

        nextStep() {
            if (this.isStepValid(this.currentStep)) {
                this.currentStep++;
                if (this.currentStep === 3) {
                    this.updateCostEstimate();
                }
            }
        },

        previousStep() {
            if (this.currentStep > 1) {
                this.currentStep--;
            }
        },

        /**
         * Handle file-ready event from drag-drop component
         * Receives file data and advances to next step
         */
        async handleFileReady(event) {
            console.log('[UnifiedCreator] File ready event received:', event.detail);

            if (event.detail && event.detail.file) {
                // Update parent state with file data
                this.inputData.file = event.detail.file;
                this.inputData.fileName = event.detail.file.name;
                this.inputData.fileType = event.detail.file.type || 'text/plain';

                // Read file content immediately using FileReader
                try {
                    this.isReadingFile = true;
                    const content = await this.readFileAsText(event.detail.file);
                    this.inputData.fileContent = content;
                    console.log('[UnifiedCreator] File content loaded:', content.substring(0, 100) + '...');
                } catch (error) {
                    console.error('[UnifiedCreator] Failed to read file:', error);
                    this.inputError = 'Failed to read file content: ' + error.message;
                    return;
                } finally {
                    this.isReadingFile = false;
                }

                // Clear any errors
                this.inputError = '';

                // Auto-advance to next step
                console.log('[UnifiedCreator] Advancing to step 2');
                this.currentStep = 2;
            }
        },

        isStepValid(step) {
            switch(step) {
                case 1: // Input validation
                    return this.inputError === '' && this.hasValidInput();
                case 2: // Config validation
                    return Object.keys(this.configErrors).length === 0 && this.config.videoId;
                case 3: // Review (always valid)
                    return true;
                default:
                    return false;
            }
        },

        hasValidInput() {
            // Don't allow proceeding while file is being read
            if (this.isReadingFile) return false;

            switch(this.inputType) {
                case 'url':
                    return this.inputData.url && this.inputData.url.trim().length > 0;
                case 'file':
                    // Check if drag-drop component has valid file OR legacy file upload
                    const dragDropValid = Alpine.store('appState')?.formData?.document?.isValid;
                    const legacyValid = this.inputData.file !== null && this.inputData.fileContent.length > 0;
                    return dragDropValid || legacyValid;
                case 'text':
                    return this.inputData.text && this.inputData.text.trim().length > 0;
                default:
                    return false;
            }
        },

        validateInput() {
            this.inputError = '';

            if (this.inputType === 'url' && this.validator) {
                const error = this.validator.validateField('url', this.inputData.url);
                if (error) {
                    this.inputError = error;
                }
            } else if (this.inputType === 'text' && this.inputData.text.trim().length < 10) {
                this.inputError = 'Text must be at least 10 characters';
            }
        },

        validateConfig() {
            this.configErrors = {};

            if (this.validator) {
                const videoIdError = this.validator.validateField('video_id', this.config.videoId);
                if (videoIdError) {
                    this.configErrors.videoId = videoIdError;
                }
            }
        },

        async handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type based on input method
            const allowedTypes = this.inputMethod === 'yaml'
                ? ['.yaml', '.yml']
                : ['.txt', '.md', '.pdf', '.docx'];

            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            if (!allowedTypes.some(ext => fileExtension === ext)) {
                this.inputError = `Invalid file type. Allowed: ${allowedTypes.join(', ')}`;
                return;
            }

            // Check file size (max 10MB for documents, 1MB for YAML)
            const maxSize = this.inputMethod === 'yaml' ? 1 * 1024 * 1024 : 10 * 1024 * 1024;
            if (file.size > maxSize) {
                const maxMB = maxSize / (1024 * 1024);
                this.inputError = `File too large. Maximum size: ${maxMB}MB`;
                return;
            }

            // Store file metadata immediately
            this.inputData.file = file;
            this.inputData.fileName = file.name;
            this.inputError = '';
            this.isReadingFile = true;

            try {
                // Handle binary files (PDF, DOCX) differently from text files
                if (fileExtension === '.pdf' || fileExtension === '.docx') {
                    // For binary files, we'll send as base64
                    const content = await this.readFileAsBase64(file);
                    this.inputData.fileContent = content;
                    this.inputData.fileType = fileExtension.substring(1); // 'pdf' or 'docx'
                } else {
                    // For text files (txt, md, yaml, yml), read as text
                    const content = await this.readFileAsText(file);

                    // Validate content isn't empty
                    if (!content || content.trim().length === 0) {
                        this.inputError = 'File is empty';
                        this.inputData.file = null;
                        this.inputData.fileName = '';
                        this.inputData.fileContent = '';
                        return;
                    }

                    // For YAML, do basic syntax validation
                    if (this.inputMethod === 'yaml') {
                        if (!this.isValidYamlSyntax(content)) {
                            this.inputError = 'Invalid YAML syntax. Please check your file.';
                            this.inputData.file = null;
                            this.inputData.fileName = '';
                            this.inputData.fileContent = '';
                            return;
                        }
                    }

                    this.inputData.fileContent = content;
                    this.inputData.fileType = 'text';
                }

                console.log(`File read successfully: ${file.name} (${this.inputData.fileContent.length} chars)`);
            } catch (error) {
                console.error('File read error:', error);
                this.inputError = 'Failed to read file: ' + error.message;
                this.inputData.file = null;
                this.inputData.fileName = '';
                this.inputData.fileContent = '';
            } finally {
                this.isReadingFile = false;
            }
        },

        // Read file as text using FileReader API
        readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error('Failed to read file'));
                reader.readAsText(file, 'UTF-8');
            });
        },

        // Read file as base64 for binary files (PDF, DOCX)
        readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    // Remove data URL prefix to get pure base64
                    const base64 = e.target.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = (e) => reject(new Error('Failed to read file'));
                reader.readAsDataURL(file);
            });
        },

        // Basic YAML syntax validation
        isValidYamlSyntax(content) {
            // Check for common YAML structure indicators
            const lines = content.split('\n');
            let hasValidStructure = false;

            for (const line of lines) {
                const trimmed = line.trim();
                // Skip empty lines and comments
                if (!trimmed || trimmed.startsWith('#')) continue;

                // Check for key-value pairs or list items
                if (trimmed.includes(':') || trimmed.startsWith('-')) {
                    hasValidStructure = true;
                    break;
                }
            }

            return hasValidStructure;
        },

        applyPreset(presetId) {
            this.selectedPreset = presetId;

            if (this.presets && this.presets[presetId]) {
                const preset = this.presets[presetId];
                const cfg = preset.config;

                this.config.languageMode = cfg.languageMode;
                this.config.targetLanguages = cfg.targetLanguages;
                this.config.primaryVoice = cfg.primaryVoice;
                this.config.color = cfg.color;
                this.config.duration = cfg.duration;
                this.config.useAI = cfg.useAI;

                this.updateCostEstimate();

                window.dispatchEvent(new CustomEvent('show-message', {
                    detail: { message: `Applied ${preset.name} preset`, type: 'success' }
                }));
            }
        },

        // ========== Generation Summary Helper Functions ==========

        /**
         * Get total number of video files that will be generated
         * Formula: (videos per set) x (number of languages)
         */
        getTotalVideoCount() {
            const videoCount = this.config.videoMode === 'single' ? 1 : this.config.videoCount;
            const langCount = this.config.languageMode === 'single' ? 1 : this.config.targetLanguages.length;
            return videoCount * langCount;
        },

        /**
         * Get explanation text for the video count calculation
         */
        getVideoCountExplanation() {
            const videoCount = this.config.videoMode === 'single' ? 1 : this.config.videoCount;
            const langCount = this.config.languageMode === 'single' ? 1 : this.config.targetLanguages.length;

            if (videoCount === 1 && langCount === 1) {
                return 'Single video, single language';
            } else if (videoCount === 1) {
                return `1 video x ${langCount} languages`;
            } else if (langCount === 1) {
                return `${videoCount} videos x 1 language`;
            } else {
                return `${videoCount} videos x ${langCount} languages`;
            }
        },

        /**
         * Format total duration of all content
         */
        formatTotalDuration() {
            const totalVideos = this.getTotalVideoCount();
            const totalSeconds = totalVideos * this.config.duration;
            const minutes = Math.floor(totalSeconds / 60);

            if (minutes < 60) {
                return `~${minutes}m`;
            } else {
                const hours = Math.floor(minutes / 60);
                const remainingMins = minutes % 60;
                return `~${hours}h ${remainingMins}m`;
            }
        },

        /**
         * Get human-readable language name from code
         */
        getLanguageName(code) {
            const languageNames = {
                'en': 'English',
                'es': 'Spanish',
                'fr': 'French',
                'de': 'German',
                'it': 'Italian',
                'pt': 'Portuguese',
                'zh': 'Chinese',
                'ja': 'Japanese',
                'ko': 'Korean',
                'ar': 'Arabic',
                'hi': 'Hindi',
                'ru': 'Russian',
                'nl': 'Dutch',
                'pl': 'Polish',
                'sv': 'Swedish',
                'tr': 'Turkish'
            };
            return languageNames[code] || code.toUpperCase();
        },

        /**
         * Get flag emoji for language code
         */
        getLanguageFlag(code) {
            const flags = {
                'en': 'üá∫üá∏',
                'es': 'üá™üá∏',
                'fr': 'üá´üá∑',
                'de': 'üá©üá™',
                'it': 'üáÆüáπ',
                'pt': 'üáµüáπ',
                'zh': 'üá®üá≥',
                'ja': 'üáØüáµ',
                'ko': 'üá∞üá∑',
                'ar': 'üá∏üá¶',
                'hi': 'üáÆüá≥',
                'ru': 'üá∑üá∫',
                'nl': 'üá≥üá±',
                'pl': 'üáµüá±',
                'sv': 'üá∏üá™',
                'tr': 'üáπüá∑'
            };
            return flags[code] || 'üåê';
        },

        updateCostEstimate() {
            if (!this.costEstimator) return;

            const estimate = this.costEstimator.estimateVideoSetCost({
                use_ai_narration: this.config.useAI,
                target_languages: this.config.targetLanguages,
                translation_method: 'claude',
                estimatedScenesPerVideo: Math.ceil(this.config.duration / 30),
                videos: [{ scenes: [] }]
            });

            this.costEstimate = estimate;
        },

        /**
         * Toggle language selection (add/remove from targetLanguages)
         */
        toggleLanguageSelection(code) {
            const index = this.config.targetLanguages.indexOf(code);
            if (index > -1) {
                // Don't remove if it's the last language
                if (this.config.targetLanguages.length > 1) {
                    this.config.targetLanguages.splice(index, 1);
                }
            } else {
                this.config.targetLanguages.push(code);
            }
            // Update language mode based on selection count
            this.config.languageMode = this.config.targetLanguages.length > 1 ? 'multi' : 'single';
            this.updateCostEstimate();
        },

        /**
         * Apply language preset (european, asian, global)
         */
        applyLanguagePreset(preset) {
            const presets = {
                'european': ['en', 'es', 'fr', 'de', 'it', 'pt'],
                'asian': ['en', 'zh', 'ja', 'ko', 'vi'],
                'global': ['en', 'es', 'zh', 'ar', 'hi', 'pt', 'ru', 'ja']
            };

            if (presets[preset]) {
                this.config.targetLanguages = [...presets[preset]];
                this.config.languageMode = this.config.targetLanguages.length > 1 ? 'multi' : 'single';
                this.updateCostEstimate();

                window.dispatchEvent(new CustomEvent('show-message', {
                    detail: { message: `Applied ${preset} language preset (${this.config.targetLanguages.length} languages)`, type: 'success' }
                }));
            }
        },

        /**
         * Start video generation with CSRF protection and error retry
         * FIX C1: Added CSRF token to all POST requests
         * FIX M2: Added retry logic for network errors
         */
        async startGeneration() {
            console.log('startGeneration called');
            this.generationStarted = true;
            this.generationProgress = 0;
            this.generationStatus = 'Preparing video generation...';
            this.retryCount = 0;

            try {
                let endpoint = '';
                let payload = {};

                console.log('Input method:', this.inputMethod);
                console.log('Input type:', this.inputType);

                // Calculate actual video count based on mode (used across all input methods)
                const videoCount = this.config.videoMode === 'single' ? 1 : this.config.videoCount;
                const splitByH2 = this.config.videoMode === 'set';

                // Determine which API endpoint to use based on input method
                if (this.inputMethod === 'youtube' || (this.inputType === 'url' && this.inputData.url.includes('youtube'))) {
                    endpoint = '/api/parse/youtube';
                    payload = {
                        url: window.securityUtils ? window.securityUtils.sanitizeUrl(this.inputData.url) : this.inputData.url,
                        duration: this.config.duration,
                        accent_color: this.config.color,
                        voice: this.config.primaryVoice,
                        video_count: videoCount
                    };
                } else if (this.inputMethod === 'yaml') {
                    // YAML configuration - send to YAML-specific endpoint
                    endpoint = '/api/parse/yaml';
                    payload = {
                        content: this.inputData.fileContent,
                        filename: window.securityUtils ? window.securityUtils.sanitizeFilename(this.inputData.fileName) : this.inputData.fileName,
                        accent_color: this.config.color,
                        voice: this.config.primaryVoice,
                        video_count: videoCount
                    };
                } else if (this.inputMethod === 'document' || this.inputType === 'file' || this.inputType === 'text') {
                    // Handle file uploads separately from text/URL input
                    if (this.inputType === 'file' && this.inputData.file) {
                        // File upload - use multipart form endpoint
                        endpoint = '/api/upload/document';

                        // Build FormData for file upload
                        const formData = new FormData();
                        formData.append('file', this.inputData.file);
                        formData.append('accent_color', this.config.color);
                        formData.append('voice', this.config.primaryVoice);
                        formData.append('video_count', videoCount);

                        console.log('Calling endpoint:', endpoint);
                        this.generationProgress = 20;
                        this.generationStatus = 'Uploading document...';

                        // Use secure form upload with CSRF
                        const response = await this._secureFormPost(endpoint, formData);

                        this.generationProgress = 40;
                        this.generationStatus = 'Generating video...';

                        if (response.ok) {
                            const result = await response.json();
                            this.generatedJobId = result.task_id;
                            await this.pollJobStatus(result.task_id);
                        } else {
                            const error = await response.json();
                            throw new Error(error.detail || 'Upload failed');
                        }
                        return;  // Exit early - file upload handled
                    }

                    // Text or URL input - use JSON endpoint
                    endpoint = '/api/parse/document';

                    // Determine content source: text input or URL
                    let content = '';
                    if (this.inputType === 'text') {
                        content = this.inputData.text;
                    } else if (this.inputType === 'url') {
                        content = window.securityUtils ? window.securityUtils.sanitizeUrl(this.inputData.url) : this.inputData.url;
                    }

                    payload = {
                        content: content,
                        filename: this.inputData.fileName ? (window.securityUtils ? window.securityUtils.sanitizeFilename(this.inputData.fileName) : this.inputData.fileName) : null,
                        file_type: this.inputData.fileType || 'text',
                        accent_color: this.config.color,
                        voice: this.config.primaryVoice,
                        video_count: videoCount,
                        split_strategy: this.config.splitStrategy,
                        enable_ai_splitting: this.config.enableAISplitting
                    };
                } else {
                    throw new Error('Unknown input method');
                }

                console.log('Calling endpoint:', endpoint);

                this.generationProgress = 20;
                this.generationStatus = 'Processing content...';

                // FIX C1: Use secure fetch with CSRF token
                const response = await this._securePost(endpoint, payload);

                this.generationProgress = 40;
                this.generationStatus = 'Generating video...';

                if (response.ok) {
                    const result = await response.json();
                    this.generatedJobId = result.task_id;

                    // Poll for completion with abort controller
                    await this.pollJobStatus(result.task_id);
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Generation failed');
                }
            } catch (error) {
                // FIX M2: Categorize and handle errors with retry
                const errorType = this._categorizeError(error);

                if (errorType === 'network' && this.retryCount < this.maxRetries) {
                    this.retryCount++;
                    console.log(`Retrying (${this.retryCount}/${this.maxRetries})...`);
                    this.generationStatus = `Network error, retrying (${this.retryCount}/${this.maxRetries})...`;
                    await this._delay(2000 * this.retryCount);
                    return this.startGeneration();
                }

                console.error('Generation error:', error);
                this.generationProgress = 0;
                this.generationStatus = this._getUserFriendlyError(errorType, error);
                this.generationStarted = false;
                window.dispatchEvent(new CustomEvent('show-message', {
                    detail: { message: this._getUserFriendlyError(errorType, error), type: 'error' }
                }));
            }
        },

        /**
         * Secure POST request with CSRF token
         * FIX C1: All POST requests include CSRF token
         */
        async _securePost(url, payload) {
            // Use securityUtils if available, otherwise fallback
            if (window.securityUtils) {
                return window.securityUtils.secureFetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
            }

            // Fallback: try to get CSRF token from meta tag
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
            const headers = { 'Content-Type': 'application/json' };
            if (csrfToken) {
                headers['X-CSRF-Token'] = csrfToken;
            }

            return fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(payload)
            });
        },

        /**
         * Secure POST request for FormData (file uploads) with CSRF token
         */
        async _secureFormPost(url, formData) {
            // Use securityUtils if available
            if (window.securityUtils) {
                return window.securityUtils.secureFetch(url, {
                    method: 'POST',
                    body: formData  // No Content-Type header - browser sets multipart boundary
                });
            }

            // Fallback: try to get CSRF token from meta tag
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
            const headers = {};  // Don't set Content-Type for FormData
            if (csrfToken) {
                headers['X-CSRF-Token'] = csrfToken;
            }

            return fetch(url, {
                method: 'POST',
                headers: headers,
                body: formData
            });
        },

        /**
         * Categorize error for handling
         * FIX M2: Error categorization
         */
        _categorizeError(error) {
            if (error.name === 'AbortError') return 'cancelled';
            if (error.name === 'TypeError' || error.message.includes('network') || error.message.includes('fetch')) return 'network';
            if (error.message.includes('CSRF')) return 'csrf';
            if (error.message.includes('timeout')) return 'timeout';
            return 'unknown';
        },

        /**
         * Get user-friendly error message
         * FIX M2: Better error messages
         */
        _getUserFriendlyError(errorType, error) {
            const messages = {
                'network': 'Network error. Please check your connection and try again.',
                'csrf': 'Session expired. Please refresh the page and try again.',
                'timeout': 'Request timed out. Please try again.',
                'cancelled': 'Request was cancelled.',
                'unknown': 'Generation failed: ' + (error.message || 'Unknown error')
            };
            return messages[errorType] || messages['unknown'];
        },

        /**
         * Delay helper for retry logic
         */
        _delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        },

        /**
         * Poll job status with proper cleanup
         * FIX C2: Uses AbortController for proper cleanup on component destruction
         */
        async pollJobStatus(taskId) {
            const maxAttempts = 60; // 2 minutes max
            let attempts = 0;

            // Create abort controller for this polling session
            this.pollAbortController = new AbortController();
            const signal = this.pollAbortController.signal;

            while (attempts < maxAttempts && !signal.aborted) {
                try {
                    // Use abort signal for fetch
                    const response = await fetch(`/api/tasks/${taskId}`, { signal });

                    if (signal.aborted) {
                        console.log('Polling aborted');
                        return;
                    }

                    if (response.ok) {
                        const status = await response.json();

                        this.generationProgress = status.progress || 50;
                        this.generationStatus = status.message || 'Processing...';

                        if (status.status === 'complete') {
                            this.generationProgress = 100;
                            this.generationStatus = 'Complete!';
                            this.generationComplete = true;
                            this._cleanupPolling();
                            window.dispatchEvent(new CustomEvent('show-message', {
                                detail: { message: 'Video generated successfully!', type: 'success' }
                            }));
                            return;
                        } else if (status.status === 'failed') {
                            this._cleanupPolling();
                            throw new Error(status.errors || 'Generation failed');
                        }
                    }
                } catch (error) {
                    // Don't log abort errors (expected during cleanup)
                    if (error.name !== 'AbortError') {
                        console.error('Polling error:', error);
                    } else {
                        return; // Exit cleanly on abort
                    }
                }

                // Abortable delay
                await this._abortableDelay(2000, signal);
                attempts++;
            }

            this._cleanupPolling();

            if (!signal.aborted) {
                throw new Error('Generation timeout');
            }
        },

        /**
         * Delay that can be aborted
         * FIX C2: Abortable timeout for clean cancellation
         */
        _abortableDelay(ms, signal) {
            return new Promise((resolve) => {
                const timeoutId = setTimeout(resolve, ms);
                signal.addEventListener('abort', () => {
                    clearTimeout(timeoutId);
                    resolve();
                }, { once: true });
            });
        },

        /**
         * Clean up polling resources
         * FIX C2: Proper resource cleanup
         */
        _cleanupPolling() {
            if (this.pollAbortController) {
                // Don't abort if already completed
                if (!this.generationComplete) {
                    this.pollAbortController.abort();
                }
                this.pollAbortController = null;
            }
        },

        /**
         * Reset component state and clean up resources
         * FIX C2: Added cleanup call to prevent memory leaks
         */
        reset() {
            // FIX C2: Clean up any active polling
            this._cleanupPolling();

            this.currentStep = 1;
            this.inputType = 'url';
            this.inputData = { url: '', file: null, fileName: '', fileContent: '', fileType: '', text: '' };
            this.inputError = '';
            this.isReadingFile = false;
            this.config = {
                videoId: '',
                duration: 120,
                languageMode: 'single',
                targetLanguages: ['en'],
                primaryVoice: 'en-US-JennyNeural',
                color: 'blue',
                useAI: false
            };
            this.configErrors = {};
            this.selectedPreset = null;
            this.generationStarted = false;
            this.generationProgress = 0;
            this.generationStatus = 'Initializing...';
            this.generationComplete = false;
            this.generatedJobId = null;
            this.retryCount = 0;
        },

        /**
         * Destroy/cleanup method for component removal
         * FIX C2: Called when component is removed from DOM
         */
        destroy() {
            this._cleanupPolling();

            // Clean up any global event listeners if needed
            if (window.securityUtils) {
                window.securityUtils.abortAllRequests();
            }
        }
    };
}
</script>
{% endblock %}
